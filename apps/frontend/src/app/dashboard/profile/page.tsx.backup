'use client';

import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useProfile } from '@/hooks/use-profile';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { User, RefreshCw, Shield, Lock, Save, X, Eye } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { toast } from '@/lib/toast';
import { formatDate } from '@/lib/utils';
import api from '@/lib/api';
import { ProfileSkeleton } from '@/components/profile/profile-skeleton';
import { ProfilePreview } from '@/components/profile/profile-preview';
import { ProfileHeader } from '@/components/profile/profile-header';
import '../../../styles/animations.css';
import { createClient } from '@/lib/supabase';

export default function ProfilePage() {
  const router = useRouter();
  const { profile, isLoading, updateProfile, updateAvatar } = useProfile();
  const [localIsLoading, setIsLoading] = useState(false);
  const [isEditing, setIsEditing] = useState(false);

  const [isSaving, setIsSaving] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [editForm, setEditForm] = useState({
    name: '',
    phone: '',
    bio: '',
    location: ''
  });

  const [formErrors, setFormErrors] = useState({
    name: '',
    phone: '',
    bio: '',
    location: ''
  });

  const [showPreview, setShowPreview] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [retryCount, setRetryCount] = useState(0);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const supabaseRef = useRef(createClient());

  // Validación en tiempo real
  const validateField = useCallback((field: string, value: string) => {
    let error = '';

    switch (field) {
      case 'name':
        if (!value.trim()) {
          error = 'El nombre es requerido';
        } else if (value.trim().length < 2) {
          error = 'El nombre debe tener al menos 2 caracteres';
        } else if (value.trim().length > 50) {
          error = 'El nombre no puede exceder 50 caracteres';
        }
        break;
      case 'phone':
        if (value && !/^(\+595\s?[0-9]{2}\s?[0-9]{7}|0[0-9]{2}\s?[0-9]{7}|[0-9]{9})$/.test(value.replace(/\s/g, ''))) {
          error = 'Formato de teléfono inválido (formato: +595 XX XXXXXXX)';
        }
        break;
      case 'bio':
        if (value.length > 500) {
          error = 'La biografía no puede exceder 500 caracteres';
        }
        break;
      case 'location':
        if (value.length > 100) {
          error = 'La ubicación no puede exceder 100 caracteres';
        }
        break;
    }

    setFormErrors(prev => ({ ...prev, [field]: error }));
    return error === '';
  }, []);

  const handleFormChange = useCallback((field: string, value: string) => {
    setEditForm(prev => ({ ...prev, [field]: value }));
    validateField(field, value);
  }, [validateField]);

  const isFormValid = useMemo(() => {
    return Object.values(formErrors).every(error => error === '') &&
      editForm.name.trim() !== '';
  }, [formErrors, editForm.name]);

  const loadUserProfile = useCallback(async () => {
    try {
      setError(null);
      setIsLoading(true);

      // Detectar modo mock para evitar llamadas a la API cuando Supabase no está configurado
      let isMockAuth = false;
      try {
        const { data: { session }, error: sessionError } = await supabaseRef.current.auth.getSession();
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        isMockAuth = !session || !!sessionError || typeof (supabaseRef.current as any).from !== 'function';
      } catch {
        isMockAuth = true;
      }

      if (isMockAuth) {
        // Usar el estado del hook como fuente y evitar la llamada a la API
        if (profile) {
          setEditForm({
            name: profile.name || '',
            phone: profile.phone || '',
            bio: profile.bio || '',
            location: profile.location || ''
          });
          setRetryCount(0);
        }
        return;
      }

      const response = await api.get('/auth/profile');
      const profileData = response.data.data;
      // setProfile(profileData); // Removed to fix unused variable
      setEditForm({
        name: profileData.name || '',
        phone: profileData.phone || '',
        bio: profileData.bio || '',
        location: profileData.location || ''
      });
      setRetryCount(0);
    } catch (error: unknown) {
      console.error('Error loading profile:', error);
      const err = error as { response?: { data?: { message?: string }; status?: number }; message?: string; code?: string };
      const errorMessage = err?.response?.data?.message ||
        err?.message ||
        "No se pudo cargar el perfil del usuario";
      setError(errorMessage);

      // Auto-retry logic for network errors
      if (retryCount < 3 && (err?.code === 'NETWORK_ERROR' || (err?.response?.status && err.response.status >= 500))) {
        setTimeout(() => {
          setRetryCount(prev => prev + 1);
          // We can't call loadUserProfile recursively directly if it's a dependency of itself
          // Instead, we just trigger a retry by state if needed, or rely on the user to retry
          // For now, let's just log that we would retry
          console.log('Would retry loading profile...');
        }, Math.pow(2, retryCount) * 1000); // Exponential backoff
      } else {
        toast.error(errorMessage);
      }
    } finally {
      setIsLoading(false);
    }
  }, [retryCount, profile]);

  const loadUserActivities = useCallback(async () => {
    // Removed - no longer needed
  }, []);

  useEffect(() => {
    if (retryCount > 0) {
      loadUserProfile();
    }
  }, [retryCount, loadUserProfile]);
  const handleRefresh = useCallback(async () => {
    setIsRefreshing(true);
    setError(null);
    try {
      await loadUserProfile();
      toast.success('Perfil actualizado correctamente');
    } catch (error) {
      console.error('Refresh error:', error);
      toast.error('Error al actualizar el perfil');
    } finally {
      setIsRefreshing(false);
    }
  }, [loadUserProfile]);

  useEffect(() => {
    loadUserProfile();
  }, [loadUserProfile]);

  const handleSaveProfile = useCallback(async () => {
    if (!isFormValid) {
      toast.error('Por favor, corrige los errores en el formulario');
      return;
    }
    // Mostrar vista previa antes de guardar
    setShowPreview(true);
  }, [isFormValid]);

  const handleConfirmSave = useCallback(async () => {
    setIsSaving(true);
    setShowPreview(false);
    try {
      // Validate form data before sending
      if (!editForm.name?.trim()) {
        throw new Error('El nombre es requerido');
      }

      // Use the useProfile hook's updateProfile method instead of API call
      const success = await updateProfile(editForm);
      if (success) {
        setIsEditing(false);
        toast.success("Perfil actualizado correctamente");
        // Refresh the local profile data
        await loadUserProfile();
        // Clear any previous errors
        setError(null);
        setRetryCount(0);
      } else {
        throw new Error('No se pudo actualizar el perfil. Por favor, inténtalo de nuevo.');
      }
    } catch (error: unknown) {
      console.error('Error saving profile:', error);
      const err = error as { response?: { data?: { message?: string } }; message?: string; code?: string };

      // More detailed error handling
      let errorMessage = "No se pudo actualizar el perfil";

      if (err?.message) {
        errorMessage = err.message;
      } else if (err?.response?.data?.message) {
        errorMessage = err.response.data.message;
      } else if (err?.code === 'NETWORK_ERROR') {
        errorMessage = "Error de conexión. Verifica tu conexión a internet.";
      } else if (err?.code === 'UNAUTHORIZED') {
        errorMessage = "Sesión expirada. Por favor, inicia sesión nuevamente.";
        router.push('/auth/signin');
        return;
      }

      setError(errorMessage);
      toast.error(errorMessage);
    } finally {
      setIsSaving(false);
    }
  }, [editForm, updateProfile, loadUserProfile, router]);

  const handleCancelPreview = useCallback(() => {
    setShowPreview(false);
  }, []);

  const handleAvatarUpload = useCallback(async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // Clear previous errors
    setError(null);

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      const errorMsg = 'El archivo es demasiado grande. Máximo 5MB permitido.';
      setError(errorMsg);
      toast.error(errorMsg);
      return;
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
      const errorMsg = 'Solo se permiten archivos de imagen (JPG, PNG, GIF, WebP).';
      setError(errorMsg);
      toast.error(errorMsg);
      return;
    }

    // Additional file type validation
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type.toLowerCase())) {
      const errorMsg = 'Formato de imagen no soportado. Use JPG, PNG, GIF o WebP.';
      setError(errorMsg);
      toast.error(errorMsg);
      return;
    }

    try {
      setIsUploading(true);
      setError(null);

      // Use the updateAvatar function from the hook
      const success = await updateAvatar(file);

      if (success) {
        toast.success("Foto de perfil actualizada correctamente");
        // Reload the profile to get the updated avatar
        await loadUserProfile();
      } else {
        throw new Error('La actualización del avatar falló');
      }
    } catch (error: unknown) {
      console.error('Error uploading avatar:', error);
      const err = error as { response?: { data?: { message?: string } }; message?: string; code?: string };

      let errorMessage = "No se pudo actualizar la foto de perfil";

      if (err?.message) {
        errorMessage = err.message;
      } else if (err?.response?.data?.message) {
        errorMessage = err.response.data.message;
      } else if (err?.code === 'NETWORK_ERROR') {
        errorMessage = "Error de conexión. Verifica tu conexión a internet.";
      } else if (err?.code === 'UNAUTHORIZED') {
        errorMessage = "Sesión expirada. Por favor, inicia sesión nuevamente.";
        router.push('/auth/signin');
        return;
      } else if (err?.code === 'PAYLOAD_TOO_LARGE') {
        errorMessage = "El archivo es demasiado grande para el servidor.";
      } else if (err?.code === 'UNSUPPORTED_MEDIA_TYPE') {
        errorMessage = "Formato de archivo no soportado.";
      }

      setError(errorMessage);
      toast.error(errorMessage);
    } finally {
      setIsUploading(false);
      // Reset the file input
      if (event.target) {
        event.target.value = '';
      }
    }
  }, [updateAvatar, loadUserProfile, router]);

  const handlePreferenceChange = useCallback((key: string, value: unknown) => {
    // Removed - no longer needed
    console.log('Preference change:', key, value);
  }, []);

  const getActivityIcon = useCallback((type: string) => {
    // Removed - no longer needed
    return null;
  }, []);

  if (isLoading || localIsLoading) {
    return <ProfileSkeleton />;
  }

  if (error && !profile) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Card className="w-96">
          <CardContent className="pt-6">
            <div className="text-center space-y-4">
              <div className="h-12 w-12 mx-auto bg-red-100 rounded-full flex items-center justify-center">
                <X className="h-6 w-6 text-red-600" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-red-900">Error al cargar el perfil</h3>
                <p className="text-red-600 mt-1">{error}</p>
              </div>
              <div className="flex gap-2 justify-center">
                <Button
                  onClick={handleRefresh}
                  disabled={isRefreshing}
                  className="button-press"
                >
                  <RefreshCw className={`h-4 w-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                  {isRefreshing ? 'Reintentando...' : 'Reintentar'}
                </Button>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard')}
                  className="button-press"
                >
                  Volver al Dashboard
                </Button>
              </div>
              {retryCount > 0 && (
                <p className="text-sm text-muted-foreground">
                  Intento {retryCount} de 3
                </p>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!profile) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Card className="w-96">
          <CardContent className="pt-6">
            <div className="text-center space-y-4">
              <User className="h-12 w-12 mx-auto text-muted-foreground" />
              <div>
                <h3 className="text-lg font-semibold">No se pudo cargar el perfil</h3>
                <p className="text-muted-foreground">Intenta recargar la página</p>
              </div>
              <Button
                onClick={handleRefresh}
                disabled={isRefreshing}
                className="button-press"
              >
                <RefreshCw className={`h-4 w-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
                {isRefreshing ? 'Cargando...' : 'Recargar'}
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-6 space-y-6 animate-fade-in">
      {/* Error banner */}
      {error && (
        <Card className="border-red-200 bg-red-50 animate-slide-in-top">
          <CardContent className="pt-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <X className="h-4 w-4 text-red-600" />
                <p className="text-red-800 text-sm">{error}</p>
              </div>
              <div className="flex gap-2">
                <Button
                  size="sm"
                  variant="outline"
                  onClick={handleRefresh}
                  disabled={isRefreshing}
                  className="button-press"
                >
                  <RefreshCw className={`h-3 w-3 mr-1 ${isRefreshing ? 'animate-spin' : ''}`} />
                  Reintentar
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => setError(null)}
                  className="button-press"
                >
                  <X className="h-3 w-3" />
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Header del perfil */}
      <ProfileHeader
        profile={profile}
        isRefreshing={isRefreshing}
        isUploading={isUploading || localIsLoading}
        isEditing={isEditing}
        onRefresh={handleRefresh}
        onToggleEdit={() => setIsEditing(!isEditing)}
        onChangePassword={() => router.push('/dashboard/profile/change-password')}
        onAvatarUpload={handleAvatarUpload}
      />

      {/* Contenido principal con tabs simplificadas */}
      <Tabs defaultValue="overview" className="space-y-6">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <TabsList
            className="grid w-full sm:w-auto grid-cols-2 h-auto p-1 bg-muted/50 rounded-lg animate-slide-in-left"
            role="tablist"
            aria-label="Secciones del perfil"
          >
            <TabsTrigger
              value="overview"
              className="flex items-center gap-2 px-4 py-2 data-[state=active]:bg-background data-[state=active]:shadow-sm transition-all smooth-transition"
              role="tab"
              aria-controls="overview-panel"
              aria-selected="true"
            >
              <User className="h-4 w-4" aria-hidden="true" />
              <span>Información Personal</span>
            </TabsTrigger>
            <TabsTrigger
              value="security"
              className="flex items-center gap-2 px-4 py-2 data-[state=active]:bg-background data-[state=active]:shadow-sm transition-all smooth-transition"
              role="tab"
              aria-controls="security-panel"
            >
              <Shield className="h-4 w-4" aria-hidden="true" />
              <span>Seguridad</span>
            </TabsTrigger>
          </TabsList>

          {/* Indicador de estado de edición */}
          {isEditing && (
            <div
              className="flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm"
              role="status"
              aria-live="polite"
            >
              <User className="h-3 w-3" aria-hidden="true" />
              Modo edición activo
            </div>
          )}
        </div>

        {/* Tab: Resumen */}
        <TabsContent
          value="overview"
          className="space-y-6 tab-content-enter"
          role="tabpanel"
          id="overview-panel"
          aria-labelledby="overview-tab"
        >
          <div className="grid gap-6 md:grid-cols-2">
            {/* Información personal */}
            <Card className="hover-lift smooth-transition">
              <CardHeader>
                <CardTitle>Información Personal</CardTitle>
                <CardDescription>
                  Gestiona tu información personal y biografía
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {isEditing ? (
                  <form onSubmit={(e) => { e.preventDefault(); handleSaveProfile(); }} aria-label="Formulario de edición de perfil">
                    <div className="space-y-2">
                      <Label htmlFor="name">Nombre completo *</Label>
                      <Input
                        id="name"
                        value={editForm.name}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleFormChange('name', e.target.value)}
                        className={`form-field-focus ${formErrors.name ? 'border-red-500 form-field-error' : ''}`}
                        aria-required="true"
                        aria-invalid={!!formErrors.name}
                        aria-describedby={formErrors.name ? 'name-error' : undefined}
                      />
                      {formErrors.name && (
                        <p id="name-error" className="text-sm text-red-500 animate-slide-in-left" role="alert">{formErrors.name}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="phone">Teléfono</Label>
                      <Input
                        id="phone"
                        value={editForm.phone}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleFormChange('phone', e.target.value)}
                        className={`form-field-focus ${formErrors.phone ? 'border-red-500 form-field-error' : ''}`}
                        placeholder="+595 21 1234567"
                        aria-invalid={!!formErrors.phone}
                        aria-describedby={formErrors.phone ? 'phone-error' : undefined}
                      />
                      {formErrors.phone && (
                        <p id="phone-error" className="text-sm text-red-500 animate-slide-in-left" role="alert">{formErrors.phone}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="location">Ubicación</Label>
                      <Input
                        id="location"
                        value={editForm.location}
                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleFormChange('location', e.target.value)}
                        className={`form-field-focus ${formErrors.location ? 'border-red-500 form-field-error' : ''}`}
                        placeholder="Ciudad, País"
                        aria-invalid={!!formErrors.location}
                        aria-describedby={formErrors.location ? 'location-error' : undefined}
                      />
                      {formErrors.location && (
                        <p id="location-error" className="text-sm text-red-500 animate-slide-in-left" role="alert">{formErrors.location}</p>
                      )}
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="bio">Biografía</Label>
                      <Textarea
                        id="bio"
                        value={editForm.bio}
                        onChange={(e: React.ChangeEvent<HTMLTextAreaElement>) => handleFormChange('bio', e.target.value)}
                        placeholder="Cuéntanos sobre ti..."
                        rows={3}
                        className={`form-field-focus ${formErrors.bio ? 'border-red-500 form-field-error' : ''}`}
                        aria-invalid={!!formErrors.bio}
                        aria-describedby={formErrors.bio ? 'bio-error bio-count' : 'bio-count'}
                      />
                      <div className="flex justify-between items-center">
                        {formErrors.bio && (
                          <p id="bio-error" className="text-sm text-red-500 animate-slide-in-left" role="alert">{formErrors.bio}</p>
                        )}
                        <p id="bio-count" className="text-xs text-muted-foreground ml-auto" aria-live="polite">
                          {editForm.bio.length}/500 caracteres
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <Button
                        type="submit"
                        disabled={isSaving || !isFormValid}
                        aria-describedby={!isFormValid ? 'form-validation-message' : undefined}
                        className="button-press"
                      >
                        <Save className="h-4 w-4 mr-2" aria-hidden="true" />
                        {isSaving ? 'Guardando...' : 'Guardar'}
                      </Button>
                      <Button
                        type="button"
                        variant="outline"
                        onClick={() => setIsEditing(false)}
                        className="button-press"
                      >
                        <X className="h-4 w-4 mr-2" aria-hidden="true" />
                        Cancelar
                      </Button>
                    </div>
                    {!isFormValid && (
                      <p id="form-validation-message" className="text-sm text-muted-foreground mt-2 animate-fade-in">
                        Por favor, completa todos los campos requeridos correctamente.
                      </p>
                    )}
                  </form>
                ) : (
                  <>
                    <div>
                      <Label className="text-sm font-medium">Nombre</Label>
                      <p className="text-sm text-muted-foreground mt-1">
                        {profile.name || 'No especificado'}
                      </p>
                    </div>
                    <Separator />
                    <div>
                      <Label className="text-sm font-medium">Email</Label>
                      <p className="text-sm text-muted-foreground mt-1">
                        {profile.email || 'No especificado'}
                      </p>
                    </div>
                    <Separator />
                    <div>
                      <Label className="text-sm font-medium">Teléfono</Label>
                      <p className="text-sm text-muted-foreground mt-1">
                        {profile.phone || 'No especificado'}
                      </p>
                    </div>
                    <Separator />
                    <div>
                      <Label className="text-sm font-medium">Ubicación</Label>
                      <p className="text-sm text-muted-foreground mt-1">
                        {profile.location || 'No especificado'}
                      </p>
                    </div>
                    <Separator />
                    <div>
                      <Label className="text-sm font-medium">Biografía</Label>
                      <p className="text-sm text-muted-foreground mt-1">
                        {profile.bio || 'No has agregado una biografía aún.'}
                      </p>
                    </div>
                    <Separator />
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <Label className="font-medium">Último acceso</Label>
                        <p className="text-muted-foreground">
                          {profile.lastLogin ? formatDate(profile.lastLogin) : 'Nunca'}
                        </p>
                      </div>
                      <div>
                        <Label className="font-medium">Estado</Label>
                        <Badge variant="outline" className="ml-2">Activo</Badge>
                      </div>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>

            {/* Información de cuenta */}
            <Card className="hover-lift smooth-transition">
              <CardHeader>
                <CardTitle>Información de Cuenta</CardTitle>
                <CardDescription>
                  Detalles de tu cuenta en el sistema
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <Label className="text-sm font-medium">Rol</Label>
                    <p className="text-sm text-muted-foreground mt-1">
                      {profile.role || 'Usuario'}
                    </p>
                  </div>
                  <Separator />
                  <div>
                    <Label className="text-sm font-medium">Fecha de registro</Label>
                    <p className="text-sm text-muted-foreground mt-1">
                      {profile.createdAt ? formatDate(profile.createdAt) : 'No disponible'}
                    </p>
                  </div>
                  <Separator />
                  <div>
                    <Label className="text-sm font-medium">ID de usuario</Label>
                    <p className="text-sm text-muted-foreground mt-1 font-mono text-xs">
                      {profile.id || 'No disponible'}
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        {/* Tab: Seguridad */}
        <TabsContent value="security" className="space-y-6 tab-content-enter">
          <Card className="hover-lift smooth-transition">
            <CardHeader>
              <CardTitle>Configuración de Seguridad</CardTitle>
              <CardDescription>
                Gestiona la seguridad de tu cuenta
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between p-4 border rounded-lg hover-lift smooth-transition animate-slide-in-left">
                <div className="space-y-1">
                  <Label className="font-medium">Cambiar contraseña</Label>
                  <p className="text-sm text-muted-foreground">
                    Actualiza tu contraseña regularmente para mantener tu cuenta segura
                  </p>
                </div>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard/profile/change-password')}
                  className="button-press"
                >
                  <Lock className="h-4 w-4 mr-2" />
                  Cambiar
                </Button>
              </div>

              <div className="flex items-center justify-between p-4 border rounded-lg hover-lift smooth-transition animate-slide-in-left" style={{ animationDelay: '0.1s' }}>
                <div className="space-y-1">
                  <Label className="font-medium">Autenticación de dos factores</Label>
                  <p className="text-sm text-muted-foreground">
                    Agrega una capa extra de seguridad a tu cuenta
                  </p>
                </div>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard/profile/two-factor')}
                  className="button-press"
                >
                  <Shield className="h-4 w-4 mr-2" />
                  Configurar
                </Button>
              </div>

              <div className="flex items-center justify-between p-4 border rounded-lg hover-lift smooth-transition animate-slide-in-left" style={{ animationDelay: '0.2s' }}>
                <div className="space-y-1">
                  <Label className="font-medium">Sesiones activas</Label>
                  <p className="text-sm text-muted-foreground">
                    Revisa y gestiona tus sesiones activas
                  </p>
                </div>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard/profile/sessions')}
                  className="button-press"
                >
                  <Eye className="h-4 w-4 mr-2" />
                  Ver sesiones
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>alid ? 'form-validation-message' : undefined}
                        className="button-press"
                      >
                        <Save className="h-4 w-4 mr-2" aria-hidden="true" />
                        {isSaving ? 'Guardando...' : 'Guardar'}
                      </Button>
                      <Button
                        type="button"
                        variant="outline"
                        onClick={() => setIsEditing(false)}
                        className="button-press"
                      >
                        <X className="h-4 w-4 mr-2" aria-hidden="true" />
                        Cancelar
                      </Button>
                    </div>
                    {!isFormValid && (
                      <p id="form-validation-message" className="text-sm text-muted-foreground mt-2 animate-fade-in">
                        Por favor, completa todos los campos requeridos correctamente.
                      </p>
                    )}
                  </form>
                ) : (
                  <>
                    <div>
                      <Label className="text-sm font-medium">Biografía</Label>
                      <p className="text-sm text-muted-foreground mt-1">
                        {profile.bio || 'No has agregado una biografía aún.'}
                      </p>
                    </div>
                    <Separator />
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <Label className="font-medium">Último acceso</Label>
                        <p className="text-muted-foreground">
                          {profile.lastLogin ? formatDate(profile.lastLogin) : 'Nunca'}
                        </p>
                      </div>
                      <div>
                        <Label className="font-medium">Estado</Label>
                        <Badge variant="outline" className="ml-2">Activo</Badge>
                      </div>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>

            {/* Información de cuenta */}
            <Card className="hover-lift smooth-transition">
              <CardHeader>
                <CardTitle>Información de Cuenta</CardTitle>
                <CardDescription>
                  Detalles de tu cuenta en el sistema
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <Label className="text-sm font-medium">Rol</Label>
                    <p className="text-sm text-muted-foreground mt-1">
                      {profile.role || 'Usuario'}
                    </p>
                  </div>
                  <Separator />
                  <div>
                    <Label className="text-sm font-medium">Fecha de registro</Label>
                    <p className="text-sm text-muted-foreground mt-1">
                      {profile.createdAt ? formatDate(profile.createdAt) : 'No disponible'}
                    </p>
                  </div>
                  <Separator />
                  <div>
                    <Label className="text-sm font-medium">ID de usuario</Label>
                    <p className="text-sm text-muted-foreground mt-1 font-mono text-xs">
                      {profile.id || 'No disponible'}
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>

        {/* Tab: Seguridad */}
        <TabsContent value="security" className="space-y-6 tab-content-enter">
          <Card className="hover-lift smooth-transition">
            <CardHeader>
              <CardTitle>Configuración de Seguridad</CardTitle>
              <CardDescription>
                Gestiona la seguridad de tu cuenta
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between p-4 border rounded-lg hover-lift smooth-transition animate-slide-in-left">
                <div className="space-y-1">
                  <Label className="font-medium">Cambiar contraseña</Label>
                  <p className="text-sm text-muted-foreground">
                    Actualiza tu contraseña regularmente para mantener tu cuenta segura
                  </p>
                </div>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard/profile/change-password')}
                  className="button-press"
                >
                  <Lock className="h-4 w-4 mr-2" />
                  Cambiar
                </Button>
              </div>

              <div className="flex items-center justify-between p-4 border rounded-lg hover-lift smooth-transition animate-slide-in-left" style={{ animationDelay: '0.1s' }}>
                <div className="space-y-1">
                  <Label className="font-medium">Autenticación de dos factores</Label>
                  <p className="text-sm text-muted-foreground">
                    Agrega una capa extra de seguridad a tu cuenta
                  </p>
                </div>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard/profile/two-factor')}
                  className="button-press"
                >
                  <Shield className="h-4 w-4 mr-2" />
                  Configurar
                </Button>
              </div>

              <div className="flex items-center justify-between p-4 border rounded-lg hover-lift smooth-transition animate-slide-in-left" style={{ animationDelay: '0.2s' }}>
                <div className="space-y-1">
                  <Label className="font-medium">Sesiones activas</Label>
                  <p className="text-sm text-muted-foreground">
                    Revisa y gestiona tus sesiones activas
                  </p>
                </div>
                <Button
                  variant="outline"
                  onClick={() => router.push('/dashboard/profile/sessions')}
                  className="button-press"
                >
                  <Eye className="h-4 w-4 mr-2" />
                  Ver sesiones
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Profile Preview Modal */}
      <ProfilePreview
        formData={editForm}
        currentData={{
          name: profile?.name || '',
          phone: profile?.phone || '',
          location: profile?.location || '',
          bio: profile?.bio || '',
          avatar: profile?.avatar || '',
          email: profile?.email || '',
          role: profile?.role || '',
          joinDate: profile?.createdAt ? formatDate(profile.createdAt) : ''
        }}
        onConfirm={handleConfirmSave}
        onCancel={handleCancelPreview}
        isVisible={showPreview}
      />
    </div>
  );
}