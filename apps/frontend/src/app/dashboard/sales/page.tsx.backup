'use client';

import { useState, useEffect, useMemo, useDeferredValue, useCallback, memo } from 'react';
import { 
  Search, Filter, Eye, Download, BarChart3, DollarSign, TrendingUp, 
  ShoppingCart, Users, Calendar, ArrowUpDown, ChevronLeft, ChevronRight, 
  Receipt, Clock, Grid3X3, List, SlidersHorizontal, X, Plus, Minus,
  CreditCard, Banknote, Smartphone, CheckCircle2, XCircle, AlertCircle,
  Target, Zap, Settings, Phone, Mail, Package, User, FileText, Printer,
  RefreshCw, MapPin, Copy, ExternalLink, ChevronDown, ChevronUp
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Progress } from '@/components/ui/progress';
import { Separator } from '@/components/ui/separator';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { useToast } from '@/components/ui/use-toast';
import { api } from '@/lib/api';
import { formatCurrency, formatDate, getHighValueThreshold } from '@/lib/utils';
import { useCurrencyFormatter } from '@/contexts/BusinessConfigContext';
import type { Sale, Customer } from '@/types';
import dynamic from 'next/dynamic';
import RealTimeIndicator from '@/components/dashboard/RealTimeIndicator';
import ErrorBoundary from '@/components/ErrorBoundary';
import { exportSales } from '@/lib/export-utils';
import { useRealTimeSales, useDesktopNotifications } from '@/hooks/useRealTimeSales';
import { PermissionGuard, PermissionProvider } from '@/components/ui/permission-guard';
import { usePagination } from '@/hooks/usePagination';
import { useLoadPerformance, useMemoryMonitor } from '@/lib/bundle-analyzer';
import { logger } from '@/lib/logger';
import { customerService } from '@/lib/supabase-utils';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { CustomerLoyaltyCard } from '@/components/loyalty/customer-loyalty-card';
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from '@/components/ui/collapsible';

interface SalesPageState {
  sales: Sale[];
  customers: Customer[];
  loading: boolean;
  searchQuery: string;
  selectedCustomer: string;
  selectedPaymentMethod: string;
  selectedStatus: string;
  selectedSaleType: string;
  dateFrom: string;
  dateTo: string;
  selectedSale: Sale | null;
  showSaleModal: boolean;
  sortBy: 'date' | 'total' | 'customer';
  sortOrder: 'asc' | 'desc';
  amountRange: string;
  discountRange: string;
  itemCountRange: string;
  couponCode: string;
  hasCoupon: string; // 'all' | 'yes' | 'no'
  quickFilter: string;
  viewMode: 'table' | 'cards';
  showAdvancedFilters: boolean;
  showCharts: boolean;
  showAnalytics: boolean;
  serverPagination: { page: number; limit: number; total: number; pages: number } | null;
}

// Componente de esqueleto de carga
function SalesLoadingSkeleton() {
  return (
    <PermissionProvider>
      <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <Skeleton className="h-8 w-48 mb-2" />
          <Skeleton className="h-4 w-96" />
        </div>
        <div className="flex gap-2">
          <Skeleton className="h-10 w-24" />
          <Skeleton className="h-10 w-24" />
        </div>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {[...Array(4)].map((_, i) => (
          <Card key={i}>
            <CardHeader className="pb-2">
              <Skeleton className="h-4 w-24" />
            </CardHeader>
            <CardContent>
              <Skeleton className="h-8 w-32 mb-2" />
              <Skeleton className="h-3 w-20" />
            </CardContent>
          </Card>
        ))}
      </div>
      
      <Card>
        <CardHeader>
          <Skeleton className="h-6 w-32" />
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {[...Array(5)].map((_, i) => (
              <div key={i} className="flex justify-between items-center p-4 border rounded-lg">
                <div className="flex items-center gap-4">
                  <Skeleton className="h-10 w-10 rounded-full" />
                  <div>
                    <Skeleton className="h-4 w-32 mb-2" />
                    <Skeleton className="h-3 w-24" />
                  </div>
                </div>
                <Skeleton className="h-6 w-20" />
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
    </PermissionProvider>
  );
}

export default function SalesPage() {
  const { toast } = useToast();
  const fmtCurrency = useCurrencyFormatter();
  const [state, setState] = useState<SalesPageState>({
    sales: [],
    customers: [],
    loading: true,
    searchQuery: '',
    selectedCustomer: '',
    selectedPaymentMethod: '',
    selectedStatus: '',
    selectedSaleType: '',
    dateFrom: '',
    dateTo: '',
    selectedSale: null,
    showSaleModal: false,
    sortBy: 'date',
    sortOrder: 'desc',
    amountRange: '',
    discountRange: '',
    itemCountRange: '',
    couponCode: '',
    hasCoupon: 'all',
    quickFilter: '',
    viewMode: 'table',
    showAdvancedFilters: false,
    showCharts: false,
    showAnalytics: false,
    serverPagination: null,
  });

  useEffect(() => {
    try {
      const saved = typeof window !== 'undefined' ? localStorage.getItem('sales:viewMode') : null;
      if (saved === 'table' || saved === 'cards') {
        setState(prev => ({ ...prev, viewMode: saved as any }));
      }
    } catch { /* no-op */ }
  }, []);

  useEffect(() => {
    try {
      if (typeof window !== 'undefined') {
        localStorage.setItem('sales:viewMode', state.viewMode);
      }
    } catch { /* no-op */ }
  }, [state.viewMode]);

  useEffect(() => {
    const id = state.selectedSale?.customer_id;
    if (!id) {
      return setCustomerDetails(null);
    }
    (async () => {
      const { data } = await customerService.getById(String(id));
      setCustomerDetails(data || null);
    })();
  }, [state.selectedSale?.customer_id]);

  useEffect(() => {
    const id = state.selectedSale?.customer_id;
    if (!id) {
      return setCustomerMetrics(null);
    }
    (async () => {
      try {
        const url = `/api/sales?customer_id=${encodeURIComponent(String(id))}&page=1&limit=1000`;
        const res = await fetch(url, { headers: { Accept: 'application/json' } });
        const json = await res.json();
        const sales = Array.isArray(json?.sales) ? json.sales : Array.isArray(json?.data) ? json.data : [];
        const totalSpent = sales.reduce((sum: number, s: any) => sum + Number(s?.total_amount || 0), 0);
        const orderCount = (json?.pagination && typeof json.pagination.total === 'number') ? json.pagination.total : sales.length;
        const lastOrderDate = sales.reduce((latest: string | undefined, s: any) => {
          const d = s?.created_at ? new Date(s.created_at).toISOString() : undefined;
          if (!latest) return d;
          return d && new Date(d) > new Date(latest) ? d : latest;
        }, undefined);
        setCustomerMetrics({ totalSpent, orderCount, lastOrderDate });
      } catch {
        setCustomerMetrics(null);
      }
    })();
  }, [state.selectedSale?.customer_id]);

  useEffect(() => {
    const id = state.selectedSale?.id;
    if (!id) return;
    (async () => {
      try {
        const res = await api.get(`/sales/${id}`);
        const raw = res.data || {};
        const saleItems = Array.isArray(raw?.saleItems) ? raw.saleItems : Array.isArray(raw?.items) ? raw.items : [];
        const items = saleItems.map((si: any) => ({
          id: si.id,
          sale_id: si.sale_id || id,
          product_id: si.product_id,
          quantity: Number(si.quantity || 0),
          unit_price: Number(si.unit_price || 0),
          total_price: Number((si.total_price ?? (Number(si.quantity || 0) * Number(si.unit_price || 0)))) || 0,
          discount_amount: Number(si.discount_amount || 0),
          product: si.product || undefined,
        }));
        if (items.length > 0) {
          setState(prev => ({
            ...prev,
            selectedSale: prev.selectedSale ? { ...prev.selectedSale, items } : prev.selectedSale,
          }));
        }
      } catch {
      }
    })();
  }, [state.selectedSale?.id]);

  const [exportLoading, setExportLoading] = useState(false);
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(true);
  const [isMarkingViewed, setIsMarkingViewed] = useState(false);
  const [dbStatus, setDbStatus] = useState<
    { status: 'checking' | 'ready' | 'created' | 'error'; message?: string }
  >({ status: 'checking' });
  const [customerDetails, setCustomerDetails] = useState<any | null>(null);
  const [customerMetrics, setCustomerMetrics] = useState<{ totalSpent: number; orderCount: number; lastOrderDate?: string } | null>(null);
  const [customerInfoOpen, setCustomerInfoOpen] = useState(false);

  // Paginación
  const { pagination, controls, setTotal } = usePagination({
    initialPage: 1,
    initialLimit: 10,
    onPageChange: () => {}
  });

  // Real-time sales hook
  const {
    sales: realTimeSales,
    isConnected,
    lastUpdate,
    newSalesCount,
    refreshSales,
    markAsViewed,
    isLoading,
    dataSource,
    serverPagination
  } = useRealTimeSales({

    enabled: autoRefreshEnabled,
    interval: 30000,
    page: pagination.page,
    limit: pagination.limit,
    filters: {
      customerId: state.selectedCustomer || undefined,
      paymentMethod: state.selectedPaymentMethod || undefined,
      status: state.selectedStatus || undefined,
      saleType: state.selectedSaleType || undefined,
      dateFrom: state.dateFrom || undefined,
      dateTo: state.dateTo || undefined,
      amountRange: state.amountRange || undefined,
      discountRange: state.discountRange || undefined,
      itemCountRange: state.itemCountRange || undefined,
      couponCode: state.couponCode || undefined,
      hasCoupon: state.hasCoupon !== 'all' ? (state.hasCoupon as 'yes' | 'no') : undefined,
    },
    onNewSale: (sale) => {
      if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
        new Notification('Nueva venta registrada', {
          body: `Venta #${sale.id} por ${fmtCurrency(sale.total_amount)}`,
          icon: '/favicon.ico'
        });
      }
    }
  });

  // Desktop notifications hook
  const { requestPermission } = useDesktopNotifications({
    onPermissionChange: (permission) => {
      setNotificationsEnabled(permission === 'granted');
    }
  });



  // React Query hooks for sales and customers
  // Paginación (movida arriba para integrarse con el hook de ventas)

  // Cargar clientes de forma simple
  const loadCustomers = useCallback(async () => {
    try {
      const response = await api.get('/customers', { timeout: 10000 });
      const customers = Array.isArray(response.data?.data) 
        ? response.data.data 
        : Array.isArray(response.data?.customers)
        ? response.data.customers
        : Array.isArray(response.data)
        ? response.data
        : [];
      setState(prev => ({ ...prev, customers }));
    } catch (error) {
      console.warn('Error loading customers:', error);
      setState(prev => ({ ...prev, customers: [] }));
    }
  }, []);

  // Hooks de rendimiento
  const perf = useLoadPerformance();
  const memory = useMemoryMonitor();

  useEffect(() => {
    if (perf && (perf.fcp || perf.lcp || perf.cls)) {
      logger.info('Métricas de rendimiento cargadas', perf);
    }
  }, [perf]);

  useEffect(() => {
    if (!perf) return;
    const alerts: string[] = [];
    if (perf.lcp && perf.lcp > 2500) {
      alerts.push(`LCP alto: ${perf.lcp.toFixed(0)}ms`);
    }
    if (perf.cls && perf.cls > 0.1) {
      alerts.push(`CLS elevado: ${perf.cls.toFixed(3)}`);
    }
    if (perf.fid && perf.fid > 100) {
      alerts.push(`FID alto: ${perf.fid.toFixed(0)}ms`);
    }
    if (alerts.length > 0) {
      logger.warn('Alertas de rendimiento', alerts);
      toast({ title: 'Rendimiento', description: alerts.join(' • '), variant: 'destructive' });
    }
  }, [perf]);

  useEffect(() => {
    if (memory) {
      logger.warn('Uso de memoria', memory);
    }
  }, [memory]);

  // Sincronizar ventas del hook con el estado local
  useEffect(() => {
    setState(prev => ({
      ...prev,
      sales: realTimeSales,
      loading: isLoading,
      serverPagination: serverPagination,
    }));
    setTotal(serverPagination?.total ?? realTimeSales.length);
  }, [realTimeSales, isLoading, serverPagination, setTotal]);

  // Refrescar ventas al cambiar paginación o filtros (debounce para suavizar ráfagas)
  useEffect(() => {
    const handle = setTimeout(() => {
      refreshSales();
    }, 400);
    return () => clearTimeout(handle);
  }, [
    pagination.page,
    pagination.limit,
    state.selectedCustomer,
    state.selectedPaymentMethod,
    state.selectedStatus,
    state.selectedSaleType,
    state.dateFrom,
    state.dateTo,
    state.amountRange,
    state.discountRange,
    state.itemCountRange,
    state.couponCode,
    state.hasCoupon,
    refreshSales
  ]);



  useEffect(() => {
    // Ejecutar setup una sola vez al montar
    let mounted = true;
    const setupAndLoad = async () => {
      try {
        setDbStatus({ status: 'checking' });
        const resp = await fetch('/api/sales/setup', { method: 'POST' });
        const data = await resp.json();

        if (data?.success) {
          const created = data?.created || {};
          if (created.sales || created.sale_items) {
            setDbStatus({ status: 'created', message: 'Tablas creadas' });
          } else {
            setDbStatus({ status: 'ready', message: 'Tablas OK' });
          }
        } else {
          setDbStatus({ status: 'error', message: data?.error || 'Error' });
        }
      } catch (e: any) {
        setDbStatus({ status: 'error', message: e?.message || 'No se pudo verificar/crear' });
      } finally {
        if (mounted) {
          await refreshSales();
          await loadCustomers();
        }
      }
    };
    setupAndLoad();
    return () => { mounted = false; };
  }, []);



  // Ventas filtradas (cliente: solo búsqueda y filtros rápidos)
  const deferredSearchQuery = useDeferredValue(state.searchQuery);
  const filteredSales = useMemo(() => {
    if (!state.sales || !Array.isArray(state.sales)) {
      return [];
    }

    let filtered = [...state.sales];

    // Búsqueda textual (cliente)
    if (deferredSearchQuery) {
      const query = deferredSearchQuery.toLowerCase();
      filtered = filtered.filter(sale => 
        sale.id.toString().includes(query) ||
        sale.customer?.name?.toLowerCase().includes(query) ||
        sale.customer?.email?.toLowerCase().includes(query) ||
        sale.notes?.toLowerCase().includes(query)
      );
    }

    // Filtros rápidos (cliente)
    if (state.quickFilter) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const thisWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
      const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      switch (state.quickFilter) {
        case 'today':
          filtered = filtered.filter(sale => new Date(sale.created_at) >= today);
          break;
        case 'week':
          filtered = filtered.filter(sale => new Date(sale.created_at) >= thisWeek);
          break;
        case 'month':
          filtered = filtered.filter(sale => new Date(sale.created_at) >= thisMonth);
          break;
        case 'high-value':
          filtered = filtered.filter(sale => sale.total_amount >= getHighValueThreshold());
          break;
      }
    }

    // Filtros avanzados locales
    if (state.selectedCustomer) {
      filtered = filtered.filter(sale => String(sale.customer_id || sale.customer?.id || '') === String(state.selectedCustomer));
    }
    if (state.selectedPaymentMethod) {
      const pm = state.selectedPaymentMethod.toUpperCase();
      filtered = filtered.filter(sale => String(sale.payment_method || '').toUpperCase() === pm);
    }
    if (state.selectedStatus) {
      const st = state.selectedStatus.toUpperCase();
      filtered = filtered.filter(sale => String(sale.status || '').toUpperCase() === st);
    }
    if (state.selectedSaleType) {
      const tp = state.selectedSaleType.toUpperCase();
      filtered = filtered.filter(sale => String(sale.sale_type || '').toUpperCase() === tp);
    }
    if (state.dateFrom) {
      const df = new Date(`${state.dateFrom}T00:00:00`).getTime();
      filtered = filtered.filter(sale => new Date(sale.created_at).getTime() >= df);
    }
    if (state.dateTo) {
      const dt = new Date(`${state.dateTo}T23:59:59`).getTime();
      filtered = filtered.filter(sale => new Date(sale.created_at).getTime() <= dt);
    }
    if (state.amountRange) {
      const r = String(state.amountRange).trim();
      if (r.endsWith('+')) {
        const min = Number(r.slice(0, -1));
        if (!Number.isNaN(min)) filtered = filtered.filter(sale => Number(sale.total_amount || 0) >= min);
      } else if (r.includes('-')) {
        const [minStr, maxStr] = r.split('-');
        const min = Number(minStr);
        const max = Number(maxStr);
        if (!Number.isNaN(min)) filtered = filtered.filter(sale => Number(sale.total_amount || 0) >= min);
        if (!Number.isNaN(max)) filtered = filtered.filter(sale => Number(sale.total_amount || 0) <= max);
      }
    }
    if (state.discountRange) {
      const r = String(state.discountRange).trim();
      if (r.endsWith('+')) {
        const min = Number(r.slice(0, -1));
        if (!Number.isNaN(min)) filtered = filtered.filter(sale => Number(sale.discount_amount || 0) >= min);
      } else if (r.includes('-')) {
        const [minStr, maxStr] = r.split('-');
        const min = Number(minStr);
        const max = Number(maxStr);
        if (!Number.isNaN(min)) filtered = filtered.filter(sale => Number(sale.discount_amount || 0) >= min);
        if (!Number.isNaN(max)) filtered = filtered.filter(sale => Number(sale.discount_amount || 0) <= max);
      } else if (/^\d+$/.test(r)) {
        const exact = Number(r);
        filtered = filtered.filter(sale => Number(sale.discount_amount || 0) === exact);
      }
    }
    if (state.itemCountRange) {
      const r = String(state.itemCountRange).trim();
      const count = (s: Sale) => Number(Array.isArray(s.items) ? s.items.length : 0);
      if (r.endsWith('+')) {
        const min = Number(r.slice(0, -1));
        if (!Number.isNaN(min)) filtered = filtered.filter(sale => count(sale) >= min);
      } else if (r.includes('-')) {
        const [minStr, maxStr] = r.split('-');
        const min = Number(minStr);
        const max = Number(maxStr);
        filtered = filtered.filter(sale => {
          const c = count(sale);
          const okMin = Number.isNaN(min) ? true : c >= min;
          const okMax = Number.isNaN(max) ? true : c <= max;
          return okMin && okMax;
        });
      } else if (/^\d+$/.test(r)) {
        const exact = Number(r);
        filtered = filtered.filter(sale => count(sale) === exact);
      }
    }
    if (state.hasCoupon && state.hasCoupon !== 'all') {
      const want = state.hasCoupon === 'yes';
      filtered = filtered.filter(sale => (sale.coupon_code ? true : false) === want);
    }
    if (state.couponCode) {
      const cc = state.couponCode.trim().toLowerCase();
      filtered = filtered.filter(sale => String(sale.coupon_code || '').toLowerCase().includes(cc));
    }

    return filtered;
  }, [
    state.sales,
    deferredSearchQuery,
    state.quickFilter,
    state.selectedCustomer,
    state.selectedPaymentMethod,
    state.selectedStatus,
    state.selectedSaleType,
    state.dateFrom,
    state.dateTo,
    state.amountRange,
    state.discountRange,
    state.itemCountRange,
    state.couponCode,
    state.hasCoupon,
  ]);

  // Ventas ordenadas
  const sortedSales = useMemo(() => {
    if (!filteredSales || !Array.isArray(filteredSales)) {
      return [];
    }
    return [...filteredSales].sort((a, b) => {
      let aValue, bValue;
      
      switch (state.sortBy) {
        case 'date':
          aValue = new Date(a.created_at).getTime();
          bValue = new Date(b.created_at).getTime();
          break;
        case 'total':
          aValue = a.total_amount;
          bValue = b.total_amount;
          break;
        case 'customer':
          aValue = a.customer?.name || '';
          bValue = b.customer?.name || '';
          break;
        default:
          return 0;
      }
      
      if (state.sortOrder === 'asc') {
        return aValue > bValue ? 1 : -1;
      } else {
        return aValue < bValue ? 1 : -1;
      }
    });
  }, [filteredSales, state.sortBy, state.sortOrder]);

  // Paginación
  const totalPages = state.serverPagination?.pages ?? Math.ceil(sortedSales.length / pagination.limit);
  const startIndex = (pagination.page - 1) * pagination.limit;
  const paginatedSales = state.serverPagination ? sortedSales : sortedSales.slice(startIndex, startIndex + pagination.limit);

  // Sincronizar total con controles de paginación
  useEffect(() => {
    const total = state.serverPagination?.total ?? sortedSales.length;
    setTotal(total);
  }, [state.serverPagination?.total, sortedSales.length, setTotal]);

  // Totales de impuestos y descuentos del conjunto filtrado
  const totalTax = useMemo(() => {
    const valid = Array.isArray(filteredSales) ? filteredSales : [];
    return valid.reduce((sum, sale) => sum + (Number(sale.tax_amount) || 0), 0);
  }, [filteredSales]);

  const totalDiscount = useMemo(() => {
    const valid = Array.isArray(filteredSales) ? filteredSales : [];
    return valid.reduce((sum, sale) => sum + (Number(sale.discount_amount) || 0), 0);
  }, [filteredSales]);

  // Estadísticas
  const salesStats = useMemo(() => {
    // Asegurar que filteredSales es un array válido
    const validFilteredSales = Array.isArray(filteredSales) ? filteredSales : [];
    const validStateSales = Array.isArray(state.sales) ? state.sales : [];
    
    const totalSales = validFilteredSales.reduce((sum, sale) => sum + sale.total_amount, 0);
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    
    const todaySales = validFilteredSales.filter(sale => 
      new Date(sale.created_at) >= todayStart
    );
    const todayTotal = todaySales.reduce((sum, sale) => sum + sale.total_amount, 0);
    
    const yesterdayStart = new Date(todayStart);
    yesterdayStart.setDate(yesterdayStart.getDate() - 1);
    const yesterdayEnd = new Date(todayStart);
    
    const yesterdaySales = validStateSales.filter(sale => {
      const saleDate = new Date(sale.created_at);
      return saleDate >= yesterdayStart && saleDate < yesterdayEnd;
    });
    const yesterdayTotal = yesterdaySales.reduce((sum, sale) => sum + sale.total_amount, 0);
    
    const dailyGrowth = yesterdayTotal > 0 ? ((todayTotal - yesterdayTotal) / yesterdayTotal) * 100 : 0;
    
    const thisWeekStart = new Date();
    thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
    thisWeekStart.setHours(0, 0, 0, 0);
    
    const thisWeekSales = validFilteredSales.filter(sale => 
      new Date(sale.created_at) >= thisWeekStart
    );
    const thisWeekTotal = thisWeekSales.reduce((sum, sale) => sum + sale.total_amount, 0);
    
    const completedSales = validFilteredSales.filter(sale => sale.status === 'COMPLETED').length;
    const pendingSales = validFilteredSales.filter(sale => sale.status === 'PENDING').length;
    
    const uniqueCustomers = new Set(validFilteredSales.map(sale => sale.customer_id)).size;
    const averageTicket = validFilteredSales.length > 0 ? totalSales / validFilteredSales.length : 0;
    
    return {
      totalSales,
      todayTotal,
      dailyGrowth,
      thisWeekTotal,
      completedSales,
      pendingSales,
      uniqueCustomers,
      averageTicket,
      totalCount: validFilteredSales.length,
      todayCount: todaySales.length
    };
  }, [filteredSales, state.sales]);

  // Handlers
  const handleViewSale = useCallback((sale: Sale) => {
    setState(prev => ({ ...prev, selectedSale: sale, showSaleModal: true }));
  }, []);

  const handleSort = (sortBy: 'date' | 'total' | 'customer') => {
    setState(prev => ({
      ...prev,
      sortBy,
      sortOrder: prev.sortBy === sortBy && prev.sortOrder === 'desc' ? 'asc' : 'desc',
    }));
    controls.goToPage(1);
  };

  const handlePageChange = useCallback((page: number) => {
    controls.goToPage(page);
  }, [controls]);

  const handleQuickFilter = useCallback((filter: string) => {
    setState(prev => ({
      ...prev,
      quickFilter: prev.quickFilter === filter ? '' : filter,
    }));
    controls.goToPage(1);
  }, [controls]);

  const clearFilters = useCallback(() => {
    setState(prev => ({
      ...prev,
      searchQuery: '',
      selectedCustomer: '',
      selectedPaymentMethod: '',
      selectedStatus: '',
      selectedSaleType: '',
      dateFrom: '',
      dateTo: '',
      amountRange: '',
      quickFilter: '',
    }));
    controls.goToPage(1);
  }, [controls]);

  const toggleCharts = useCallback(() => {
    setState(prev => ({ ...prev, showCharts: !prev.showCharts }));
  }, []);

  const toggleAnalytics = useCallback(() => {
    setState(prev => ({ ...prev, showAnalytics: !prev.showAnalytics }));
  }, []);

  const handleExport = async () => {
    try {
      setExportLoading(true);
      
      // Ensure filteredSales is a valid array before mapping
      if (!filteredSales || !Array.isArray(filteredSales)) {
        console.error('No sales data available for export');
        return;
      }
      
      // Transform Supabase Sale type to export Sale type
      const transformedSales = filteredSales.map(sale => ({
        id: sale.id,
        customer: sale.customer?.name || 'Cliente sin nombre',
        items: sale.items?.length || 0,
        total: sale.total_amount,
        paymentMethod: sale.payment_method,
        status: sale.status,
        date: sale.created_at,
        notes: sale.notes
      }));
      
      await exportSales(transformedSales, {
        format: 'excel',
        dateRange: { from: '', to: '' },
        includeFields: ['id', 'customer', 'total', 'paymentMethod', 'status', 'date'],
        summary: true,
        filters: {}
      });
      
      toast({
        title: "Éxito",
        description: "Ventas exportadas correctamente",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "No se pudieron exportar las ventas",
        variant: "destructive",
      });
    } finally {
      setExportLoading(false);
    }
  };

  const SaleRow = memo(({ sale, onView }: { sale: Sale; onView: (s: Sale) => void }) => {
    return (
      <tr className="border-b hover:bg-muted/50 [content-visibility:auto] [contain-intrinsic-size:80px]">
        <td className="p-4">
          <div className="flex flex-col">
            <span className="font-medium">{formatDate(sale.created_at)}</span>
            <span className="text-sm text-muted-foreground">{new Date(sale.created_at).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
          </div>
        </td>
        <td className="p-4">
          <span className="text-muted-foreground">#{sale.id}</span>
        </td>
        <td className="p-4">
          <div className="flex flex-col">
            <span className="font-medium">{sale.customer?.name || 'Cliente Anónimo'}</span>
            {sale.customer?.email && (
              <span className="text-sm text-muted-foreground">{sale.customer.email}</span>
            )}
          </div>
        </td>
        <td className="p-4">
          <div className="flex items-center gap-2">
            <Package className="h-4 w-4 text-muted-foreground" />
            <span>{sale.items?.length || 0} productos</span>
          </div>
        </td>
        <td className="p-4">
          <div className="flex flex-col">
            <span>{fmtCurrency((sale.total_amount || 0) - (sale.tax_amount || 0))}</span>
          </div>
        </td>
        <td className="p-4">
          <div className="flex flex-col">
            <span>{fmtCurrency(sale.tax_amount || 0)}</span>
          </div>
        </td>
        <td className="p-4">
          <div className="flex flex-col">
            <span className="font-bold text-green-600">{fmtCurrency(sale.total_amount)}</span>
            {sale.discount_amount > 0 && (
              <span className="text-sm text-red-500">-{fmtCurrency(sale.discount_amount)} desc.</span>
            )}
            {sale.discount_amount > 0 && sale.discount_type && (
              <span className="text-xs text-muted-foreground">Tipo: {sale.discount_type === 'PERCENTAGE' ? 'Porcentaje' : 'Monto fijo'}</span>
            )}
            {sale.coupon_code && (
              <span className="text-xs text-muted-foreground">Cupón: {sale.coupon_code}</span>
            )}
          </div>
        </td>
        <td className="p-4">
          <Badge variant="outline" className="flex items-center gap-1 w-fit">
            {sale.payment_method === 'CASH' && <Banknote className="h-3 w-3" />}
            {sale.payment_method === 'CARD' && <CreditCard className="h-3 w-3" />}
            {sale.payment_method === 'TRANSFER' && <Smartphone className="h-3 w-3" />}
            {sale.payment_method === 'CASH' ? 'Efectivo' : sale.payment_method === 'CARD' ? 'Tarjeta' : sale.payment_method === 'TRANSFER' ? 'Transferencia' : 'Otro'}
          </Badge>
        </td>
        <td className="p-4">
          <Badge variant="outline" className="w-fit">{sale.sale_type === 'WHOLESALE' ? 'Mayorista' : 'Retail'}</Badge>
        </td>
        <td className="p-4">
          <Badge 
            variant={sale.status === 'COMPLETED' ? 'default' : sale.status === 'PENDING' ? 'secondary' : 'destructive'}
            className="flex items-center gap-1 w-fit"
          >
            {sale.status === 'COMPLETED' && <CheckCircle2 className="h-3 w-3" />}
            {sale.status === 'PENDING' && <AlertCircle className="h-3 w-3" />}
            {sale.status === 'CANCELLED' && <XCircle className="h-3 w-3" />}
            {sale.status === 'COMPLETED' ? 'Completada' : sale.status === 'PENDING' ? 'Pendiente' : 'Cancelada'}
          </Badge>
        </td>
        <td className="p-4">
          <div className="flex flex-col">
            <span className="text-sm">{sale.user?.name || 'N/A'}</span>
          </div>
        </td>
        <td className="p-4">
          <Button variant="outline" size="sm" onClick={() => onView(sale)}>
            <Eye className="h-4 w-4 mr-1" />
            Ver
          </Button>
        </td>
      </tr>
    );
  });

  if (state.loading) {
    return <SalesLoadingSkeleton />;
  }

  return (
    <PermissionProvider>
      <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            Dashboard de Ventas
          </h1>
          <p className="text-muted-foreground mt-1">
            Gestiona y analiza todas tus ventas en tiempo real
          </p>
        </div>
        
        <div className="flex items-center gap-2">
          {/* Indicador de estado de BD */}
          <Badge
            variant={
              dbStatus.status === 'error'
                ? 'destructive'
                : dbStatus.status === 'created'
                ? 'default'
                : 'secondary'
            }
            className="text-xs"
            title={dbStatus.message || ''}
          >
            {dbStatus.status === 'checking'
              ? 'BD: verificando'
              : dbStatus.status === 'error'
              ? 'BD: error'
              : dbStatus.status === 'created'
              ? 'BD: creada'
              : 'BD: OK'}
          </Badge>

          <RealTimeIndicator 
            isConnected={isConnected}
            lastUpdate={lastUpdate}
            newSalesCount={newSalesCount}
            onRefresh={() => refreshSales()}
            onMarkAsViewed={async () => {
              try {
                setIsMarkingViewed(true);
                await Promise.resolve(markAsViewed());
                await refreshSales();
                toast({ title: 'Actualizado', description: 'Ventas marcadas como vistas.' });
              } catch (error) {
                logger.error('Error al marcar como visto', error);
                toast({ title: 'Error', description: 'No se pudo marcar como visto.', variant: 'destructive' });
              } finally {
                setIsMarkingViewed(false);
              }
            }}
            onToggleNotifications={() => {
              if (notificationsEnabled) {
                // Desactivar notificaciones a nivel local (no se puede revocar permiso)
                setNotificationsEnabled(false);
              } else {
                // Solicitar permiso al usuario
                requestPermission();
              }
            }}
            notificationsEnabled={notificationsEnabled}
            isRefreshing={isLoading}
            isMarkingViewed={isMarkingViewed}
            dataSource={dataSource}
          />
          
          {/* Botón para controlar actualizaciones automáticas */}
          <Button
            variant={autoRefreshEnabled ? "default" : "outline"}
            size="sm"
            onClick={() => setAutoRefreshEnabled(!autoRefreshEnabled)}
            className="flex items-center gap-2"
            aria-pressed={autoRefreshEnabled}
            aria-label={autoRefreshEnabled ? 'Desactivar actualizaciones automáticas' : 'Activar actualizaciones automáticas'}
            title={autoRefreshEnabled ? 'Desactivar actualizaciones automáticas' : 'Activar actualizaciones automáticas'}
            aria-controls="sales-table"
          >
            <RefreshCw className={`h-4 w-4 ${autoRefreshEnabled ? 'animate-spin' : ''}`} />
            {autoRefreshEnabled ? 'Auto ON' : 'Auto OFF'}
          </Button>
          <span className="sr-only" aria-live="polite" role="status">
            {autoRefreshEnabled ? 'Actualizaciones automáticas activas' : 'Actualizaciones automáticas inactivas'}
          </span>
          
          <div className="flex gap-2">
            <Button
              variant={state.viewMode === 'table' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setState(prev => ({ ...prev, viewMode: 'table' }))}
            >
              <List className="h-4 w-4" />
            </Button>
            <Button
              variant={state.viewMode === 'cards' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setState(prev => ({ ...prev, viewMode: 'cards' }))}
            >
              <Grid3X3 className="h-4 w-4" />
            </Button>
          </div>
          
          {/* Exportación centralizada en SalesExportLazy (abajo) */}
          <PermissionGuard permission="sales.reports">
            <div className="hidden">
              {/* Se elimina el botón redundante para evitar duplicación */}
            </div>
          </PermissionGuard>
          
          <PermissionGuard permission="sales.reports">
            <Button variant="outline">
              <BarChart3 className="h-4 w-4 mr-2" />
              Reportes
            </Button>
          </PermissionGuard>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 [content-visibility:auto] [contain-intrinsic-size:180px]">
        <Card className="border-l-4 border-l-green-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Ventas</CardTitle>
            <DollarSign className="h-4 w-4 text-green-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">
              {fmtCurrency(salesStats.totalSales)}
            </div>
            <div className="flex items-center text-xs text-muted-foreground mt-1">
              <TrendingUp className="h-3 w-3 mr-1" />
              {salesStats.totalCount} ventas
            </div>
            <Progress value={75} className="mt-2 h-1" />
          </CardContent>
        </Card>

        <Card className="border-l-4 border-l-blue-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Ventas Hoy</CardTitle>
            <Calendar className="h-4 w-4 text-blue-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-blue-600">
              {fmtCurrency(salesStats.todayTotal)}
            </div>
            <div className="flex items-center text-xs mt-1">
              {salesStats.dailyGrowth >= 0 ? (
                <TrendingUp className="h-3 w-3 mr-1 text-green-500" />
              ) : (
                <TrendingUp className="h-3 w-3 mr-1 text-red-500 rotate-180" />
              )}
              <span className={salesStats.dailyGrowth >= 0 ? 'text-green-500' : 'text-red-500'}>
                {Math.abs(salesStats.dailyGrowth).toFixed(1)}%
              </span>
              <span className="text-muted-foreground ml-1">vs ayer</span>
            </div>
            <Progress value={60} className="mt-2 h-1" />
          </CardContent>
        </Card>

        <Card className="border-l-4 border-l-purple-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Ticket Promedio</CardTitle>
            <Target className="h-4 w-4 text-purple-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-purple-600">
              {fmtCurrency(salesStats.averageTicket)}
            </div>
            <div className="flex items-center gap-2 mt-1">
              <Badge variant="secondary" className="text-xs">
                <CheckCircle2 className="h-3 w-3 mr-1" />
                {salesStats.completedSales} completadas
              </Badge>
            </div>
            <Progress value={85} className="mt-2 h-1" />
          </CardContent>
        </Card>

        <Card className="border-l-4 border-l-orange-500">
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Clientes Únicos</CardTitle>
            <Users className="h-4 w-4 text-orange-600" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">
              {salesStats.uniqueCustomers}
            </div>
            <div className="flex items-center gap-2 mt-1">
              <Badge variant="outline" className="text-xs">
                <AlertCircle className="h-3 w-3 mr-1" />
                {salesStats.pendingSales} pendientes
              </Badge>
            </div>
            <Progress value={70} className="mt-2 h-1" />
          </CardContent>
        </Card>
      </div>

      {/* Filtros Rápidos */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Zap className="h-5 w-5" />
            Filtros Rápidos
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-wrap gap-2">
            <Button
              variant={state.quickFilter === 'today' ? 'default' : 'outline'}
              size="sm"
              onClick={() => handleQuickFilter('today')}
              aria-label="Filtrar ventas de hoy"
            >
              Hoy
            </Button>
            <Button
              variant={state.quickFilter === 'week' ? 'default' : 'outline'}
              size="sm"
              onClick={() => handleQuickFilter('week')}
              aria-label="Filtrar ventas de esta semana"
            >
              Esta Semana
            </Button>
            <Button
              variant={state.quickFilter === 'month' ? 'default' : 'outline'}
              size="sm"
              onClick={() => handleQuickFilter('month')}
              aria-label="Filtrar ventas de este mes"
            >
              Este Mes
            </Button>
            <Button
              variant={state.quickFilter === 'high-value' ? 'default' : 'outline'}
              size="sm"
              onClick={() => handleQuickFilter('high-value')}
              aria-label="Filtrar ventas de alto valor"
            >
              Alto Valor ({getHighValueThreshold()}+)
            </Button>
            <Separator orientation="vertical" className="h-8" />
            <Button
              variant="ghost"
              size="sm"
              onClick={clearFilters}
              className="text-muted-foreground"
            >
              <X className="h-4 w-4 mr-1" />
              Limpiar Filtros
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Charts y Analytics */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Charts y Analytics (lazy + toggles) */}
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2">
            <BarChart3 className="h-5 w-5" />
            Visualizaciones
          </CardTitle>
          <div className="flex gap-2">
            <Button
              variant={state.showCharts ? 'default' : 'outline'}
              size="sm"
              onClick={() => setState(prev => ({ ...prev, showCharts: !prev.showCharts }))}
            >
              Gráficas
            </Button>
            <Button
              variant={state.showAnalytics ? 'default' : 'outline'}
              size="sm"
              onClick={() => setState(prev => ({ ...prev, showAnalytics: !prev.showAnalytics }))}
            >
              Analítica
            </Button>
          </div>
        </div>

        {(state.showCharts || state.showAnalytics) && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 [content-visibility:auto] [contain-intrinsic-size:240px]">
            {state.showCharts && (
              <ErrorBoundary fallback={<div className="p-2 text-sm text-red-600">Error al cargar gráficas</div>}>
                <SalesChartsLazy sales={filteredSales} isFetching={isLoading} onRefresh={() => refreshSales()} />
              </ErrorBoundary>
            )}
            {state.showAnalytics && (
              <ErrorBoundary fallback={<div className="p-2 text-sm text-red-600">Error al cargar analítica</div>}>
                <SalesAnalyticsLazy sales={filteredSales} isFetching={isLoading} onRefresh={() => refreshSales()} />
              </ErrorBoundary>
            )}
          </div>
        )}

        {/* Manual Refresh and Export Actions */}
        <div className="flex items-center justify-between gap-4" id="sales-export-widget">
          <Button
            onClick={() => refreshSales()}
            disabled={isLoading}
            variant="outline"
            className="flex items-center gap-2"
          >
            <RefreshCw className={`h-4 w-4 ${isLoading ? 'animate-spin' : ''}`} />
            {isLoading ? 'Actualizando...' : 'Actualizar Datos'}
          </Button>
          <ErrorBoundary fallback={<div className="text-sm text-red-600">Error al cargar exportación</div>}>
            <SalesExportLazy 
              sales={Array.isArray(filteredSales) ? filteredSales.map(sale => ({
                id: sale.id,
                customer: sale.customer?.name || 'Cliente sin nombre',
                items: sale.items?.length || 0,
                total: sale.total_amount,
                paymentMethod: sale.payment_method,
                status: sale.status,
                date: sale.created_at,
                notes: sale.notes
              })) : []} 
              onExport={(format, options) => {
                console.log('Export requested:', format, options);
            }}
          />
          </ErrorBoundary>
        </div>
      </div>

      {/* Filtros Avanzados */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center gap-2">
              <SlidersHorizontal className="h-5 w-5" />
              Filtros Avanzados
            </CardTitle>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setState(prev => ({ ...prev, showAdvancedFilters: !prev.showAdvancedFilters }))}
            >
              {state.showAdvancedFilters ? <Minus className="h-4 w-4" /> : <Plus className="h-4 w-4" />}
            </Button>
          </div>
        </CardHeader>
        
        {state.showAdvancedFilters && (
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="space-y-2">
                <Label htmlFor="search">Buscar</Label>
                <div className="relative">
                  <Search className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                  <Input
                    id="search"
                    placeholder="ID, cliente o email..."
                    value={state.searchQuery}
                    onChange={(e) => { setState(prev => ({ ...prev, searchQuery: e.target.value })); controls.goToPage(1); }}
                    className="pl-10"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="customer">Cliente</Label>
                <Select
                  value={state.selectedCustomer || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, selectedCustomer: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos los clientes" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos los clientes</SelectItem>
                    {state.customers.map((customer) => (
                      <SelectItem key={customer.id} value={customer.id}>
                        {customer.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="payment">Método de Pago</Label>
                <Select
                  value={state.selectedPaymentMethod || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, selectedPaymentMethod: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos los métodos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos los métodos</SelectItem>
                    <SelectItem value="cash">Efectivo</SelectItem>
                    <SelectItem value="card">Tarjeta</SelectItem>
                    <SelectItem value="transfer">Transferencia</SelectItem>
                    <SelectItem value="other">Otro</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="status">Estado</Label>
                <Select
                  value={state.selectedStatus || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, selectedStatus: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos los estados" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos los estados</SelectItem>
                    <SelectItem value="completed">Completada</SelectItem>
                    <SelectItem value="pending">Pendiente</SelectItem>
                    <SelectItem value="cancelled">Cancelada</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="saleType">Tipo</Label>
                <Select
                  value={state.selectedSaleType || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, selectedSaleType: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos los tipos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos los tipos</SelectItem>
                    <SelectItem value="retail">Retail</SelectItem>
                    <SelectItem value="wholesale">Mayorista</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="dateFrom">Fecha Desde</Label>
                <Input
                  id="dateFrom"
                  type="date"
                  value={state.dateFrom}
                  onChange={(e) => { setState(prev => ({ ...prev, dateFrom: e.target.value })); controls.goToPage(1); }}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="dateTo">Fecha Hasta</Label>
                <Input
                  id="dateTo"
                  type="date"
                  value={state.dateTo}
                  onChange={(e) => { setState(prev => ({ ...prev, dateTo: e.target.value })); controls.goToPage(1); }}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="amountRange">Rango de Monto</Label>
                <Select
                  value={state.amountRange || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, amountRange: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos los montos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos los montos</SelectItem>
                    <SelectItem value="0-50">0 - 50</SelectItem>
                  <SelectItem value="50-100">50 - 100</SelectItem>
                  <SelectItem value={`100-${getHighValueThreshold()}`}>100 - {getHighValueThreshold()}</SelectItem>
                  <SelectItem value={`${getHighValueThreshold()}+`}>{getHighValueThreshold()}+</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="discountRange">Rango de Descuento</Label>
                <Select
                  value={state.discountRange || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, discountRange: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos los descuentos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="0">Sin descuento</SelectItem>
                    <SelectItem value="1-10">1 - 10</SelectItem>
                    <SelectItem value="10-50">10 - 50</SelectItem>
                    <SelectItem value="50+">50+</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="itemCountRange">Cantidad de Ítems</Label>
                <Select
                  value={state.itemCountRange || 'all'}
                  onValueChange={(value) => { const v = value==='all' ? '' : value; setState(prev => ({ ...prev, itemCountRange: v })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todas las cantidades" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todas</SelectItem>
                    <SelectItem value="1">1</SelectItem>
                    <SelectItem value="2-5">2 - 5</SelectItem>
                    <SelectItem value="6-10">6 - 10</SelectItem>
                    <SelectItem value="10+">10+</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="couponCode">Cupón</Label>
                <Input
                  id="couponCode"
                  placeholder="Código de cupón..."
                  value={state.couponCode}
                  onChange={(e) => { setState(prev => ({ ...prev, couponCode: e.target.value })); controls.goToPage(1); }}
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="hasCoupon">Con Cupón</Label>
                <Select
                  value={state.hasCoupon || 'all'}
                  onValueChange={(value) => { setState(prev => ({ ...prev, hasCoupon: value })); controls.goToPage(1); }}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="yes">Sí</SelectItem>
                    <SelectItem value="no">No</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="itemsPerPage">Elementos por página</Label>
                <Select
                  value={pagination.limit.toString()}
                  onValueChange={(value) => controls.setLimit(parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="5">5</SelectItem>
                    <SelectItem value="10">10</SelectItem>
                    <SelectItem value="25">25</SelectItem>
                    <SelectItem value="50">50</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        )}
      </Card>

      {/* Tabla o Vista de Tarjetas */}
      <Card>
        <CardHeader>
          <div className="flex justify-between items-center">
            <CardTitle>
              Ventas ({state.itemCountRange ? filteredSales.length : (state.serverPagination?.total ?? filteredSales.length)})
            </CardTitle>
            <div className="text-sm text-muted-foreground">
              Mostrando {startIndex + 1}-{Math.min(startIndex + pagination.limit, state.itemCountRange ? sortedSales.length : (state.serverPagination?.total ?? sortedSales.length))} de {state.itemCountRange ? sortedSales.length : (state.serverPagination?.total ?? sortedSales.length)}
              <div className="mt-1">
                Impuestos: {fmtCurrency(totalTax)} • Descuento: {fmtCurrency(totalDiscount)}
              </div>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {dbStatus.status === 'error' ? (
            <div className="p-4 text-sm text-red-600 flex items-center gap-2">
              <AlertCircle className="h-4 w-4" />
              <span>Error al verificar/crear tablas.</span>
              <Button variant="outline" size="sm" onClick={() => refreshSales()}>
                Reintentar
              </Button>
            </div>
          ) : state.viewMode === 'table' ? (
            <div
              className="overflow-x-auto [content-visibility:auto] [contain-intrinsic-size:300px]"
              aria-busy={isLoading}
            >
              <table id="sales-table" className="w-full [content-visibility:auto] [contain-intrinsic-size:800px]">
                <thead>
                  <tr className="border-b">
                    <th
                      className="text-left p-4"
                      scope="col"
                      aria-sort={state.sortBy === 'date' ? (state.sortOrder === 'asc' ? 'ascending' : 'descending') : 'none'}
                    >
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleSort('date')}
                        className="font-semibold"
                        aria-label={`Ordenar por fecha ${state.sortBy === 'date' && state.sortOrder === 'desc' ? 'ascendente' : 'descendente'}`}
                        title={`Ordenar por fecha ${state.sortBy === 'date' && state.sortOrder === 'desc' ? 'ascendente' : 'descendente'}`}
                      >
                        Fecha
                        <ArrowUpDown className="ml-2 h-4 w-4" />
                      </Button>
                    </th>
                    <th className="text-left p-4" scope="col">ID</th>
                    <th
                      className="text-left p-4"
                      scope="col"
                      aria-sort={state.sortBy === 'customer' ? (state.sortOrder === 'asc' ? 'ascending' : 'descending') : 'none'}
                    >
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleSort('customer')}
                        className="font-semibold"
                        aria-label={`Ordenar por cliente ${state.sortBy === 'customer' && state.sortOrder === 'desc' ? 'ascendente' : 'descendente'}`}
                        title={`Ordenar por cliente ${state.sortBy === 'customer' && state.sortOrder === 'desc' ? 'ascendente' : 'descendente'}`}
                      >
                        Cliente
                        <ArrowUpDown className="ml-2 h-4 w-4" />
                      </Button>
                    </th>
                    <th className="text-left p-4" scope="col">Productos</th>
                    <th className="text-left p-4" scope="col">Subtotal</th>
                    <th className="text-left p-4" scope="col">IVA</th>
                    <th
                      className="text-left p-4"
                      scope="col"
                      aria-sort={state.sortBy === 'total' ? (state.sortOrder === 'asc' ? 'ascending' : 'descending') : 'none'}
                    >
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleSort('total')}
                        className="font-semibold"
                        aria-label={`Ordenar por total ${state.sortBy === 'total' && state.sortOrder === 'desc' ? 'ascendente' : 'descendente'}`}
                        title={`Ordenar por total ${state.sortBy === 'total' && state.sortOrder === 'desc' ? 'ascendente' : 'descendente'}`}
                      >
                        Total
                        <ArrowUpDown className="ml-2 h-4 w-4" />
                      </Button>
                    </th>
                    <th className="text-left p-4" scope="col">Pago</th>
                    <th className="text-left p-4" scope="col">Tipo</th>
                    <th className="text-left p-4" scope="col">Estado</th>
                    <th className="text-left p-4" scope="col">Vendedor</th>
                    <th className="text-left p-4" scope="col">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {isLoading && (
                    Array.from({ length: Math.min(pagination.limit, 10) }).map((_, i) => (
                      <tr key={`skeleton-${i}`} className="border-b [content-visibility:auto] [contain-intrinsic-size:80px]">
                        <td className="p-4"><Skeleton className="h-4 w-24" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-16" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-32" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-16" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-20" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-20" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-16" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-16" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-20" /></td>
                        <td className="p-4"><Skeleton className="h-4 w-24" /></td>
                        <td className="p-4"><Skeleton className="h-8 w-20" /></td>
                      </tr>
                    ))
                  )}
                  {paginatedSales.length === 0 && !isLoading ? (
                    <tr>
                      <td colSpan={12} className="p-6 text-center">
                        <div className="flex flex-col items-center gap-3 text-muted-foreground">
                          <div className="flex items-center gap-2">
                            <AlertCircle className="h-4 w-4 text-red-600" />
                            <span>No hay resultados para los filtros actuales.</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Button variant="outline" size="sm" onClick={clearFilters}>Limpiar filtros</Button>
                            <Button variant="outline" size="sm" onClick={() => controls.goToPage(1)}>Ir a página 1</Button>
                          </div>
                        </div>
                      </td>
                    </tr>
                  ) : (
                  paginatedSales.map((sale) => (
                    <SaleRow key={sale.id} sale={sale} onView={handleViewSale} />
                  )))}
                </tbody>
              </table>
            </div>
          ) : (
            /* Vista de Tarjetas */
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 [content-visibility:auto] [contain-intrinsic-size:320px]">
              {paginatedSales.map((sale) => (
                <Card key={sale.id} className="hover:shadow-md transition-shadow">
                  <CardHeader className="pb-3">
                    <div className="flex justify-between items-start">
                      <div>
                        <CardTitle className="text-lg">Venta #{sale.id}</CardTitle>
                        <CardDescription>
                          {formatDate(sale.created_at)} • {new Date(sale.created_at).toLocaleTimeString('es-ES', {
                            hour: '2-digit',
                            minute: '2-digit'
                          })}
                        </CardDescription>
                      </div>
                      <Badge 
                        variant={
                          sale.status === 'COMPLETED' ? 'default' : 
                          sale.status === 'PENDING' ? 'secondary' : 'destructive'
                        }
                        className="flex items-center gap-1"
                      >
                        {sale.status === 'COMPLETED' && <CheckCircle2 className="h-3 w-3" />}
                        {sale.status === 'PENDING' && <AlertCircle className="h-3 w-3" />}
                        {sale.status === 'CANCELLED' && <XCircle className="h-3 w-3" />}
                        {sale.status === 'COMPLETED' ? 'Completada' : 
                         sale.status === 'PENDING' ? 'Pendiente' : 'Cancelada'}
                      </Badge>
                    </div>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div className="flex items-center gap-2">
                      <User className="h-4 w-4 text-muted-foreground" />
                      <div className="flex flex-col">
                        <span className="font-medium">{sale.customer?.name || 'Cliente Anónimo'}</span>
                        {sale.customer?.email && (
                          <span className="text-sm text-muted-foreground">{sale.customer.email}</span>
                        )}
                        {sale.coupon_code && (
                          <span className="text-xs text-muted-foreground">Cupón: {sale.coupon_code}</span>
                        )}
                      </div>
                    </div>
                    
                    <div className="flex items-center gap-2">
                      <Package className="h-4 w-4 text-muted-foreground" />
                      <span>{sale.items?.length || 0} productos</span>
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        {sale.payment_method === 'CASH' && <Banknote className="h-4 w-4 text-muted-foreground" />}
                        {sale.payment_method === 'CARD' && <CreditCard className="h-4 w-4 text-muted-foreground" />}
                        {sale.payment_method === 'TRANSFER' && <Smartphone className="h-4 w-4 text-muted-foreground" />}
                        <span className="text-sm">
                          {sale.payment_method === 'CASH' ? 'Efectivo' :
                           sale.payment_method === 'CARD' ? 'Tarjeta' :
                           sale.payment_method === 'TRANSFER' ? 'Transferencia' : 'Otro'}
                        </span>
                      </div>
                      <div className="text-right">
                        <div className="font-bold text-green-600 text-lg">
                          {fmtCurrency(sale.total_amount)}
                        </div>
                        {sale.discount_amount > 0 && (
                          <div className="text-sm text-red-500">
                            -{fmtCurrency(sale.discount_amount)} desc.
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleViewSale(sale)}
                      className="w-full"
                    >
                      <Eye className="h-4 w-4 mr-2" />
                      Ver Detalles
                    </Button>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}

          {/* Paginación */}
          {totalPages > 1 && (
            <div className="flex items-center justify-between mt-6">
              <div className="text-sm text-muted-foreground">
                Página {pagination.page} de {totalPages}
              </div>
              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => controls.previousPage()}
                  disabled={!pagination.hasPreviousPage}
                >
                  <ChevronLeft className="h-4 w-4 mr-1" />
                  Anterior
                </Button>
                
                <div className="flex gap-1">
                  {(() => {
                    const startPage = Math.max(1, pagination.page - 2);
                    const endPage = Math.min(totalPages, startPage + 4);
                    return Array.from({ length: endPage - startPage + 1 }, (_, i) => {
                      const page = startPage + i;
                      return (
                        <Button
                          key={page}
                          variant={pagination.page === page ? 'default' : 'outline'}
                          size="sm"
                          onClick={() => handlePageChange(page)}
                          aria-current={pagination.page === page ? 'page' : undefined}
                        >
                          {page}
                        </Button>
                      );
                    });
                  })()}
                </div>
                
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => controls.nextPage()}
                  disabled={!pagination.hasNextPage}
                >
                  Siguiente
                  <ChevronRight className="h-4 w-4 ml-1" />
                </Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Modal de Detalles de Venta */}
      <ErrorBoundary>
      <Dialog open={state.showSaleModal} onOpenChange={(open) => setState(prev => ({ ...prev, showSaleModal: open }))}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto [content-visibility:auto] [contain-intrinsic-size:480px]" aria-labelledby="sale-details-title">
          <DialogTitle className="sr-only">Detalles de Venta</DialogTitle>
          <div id="sale-print-area">
            <div className="print-only print-header">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-lg font-semibold">Sistema de Inventario POS</h2>
                  <p className="text-xs text-muted-foreground">Recibo de Venta #{state.selectedSale?.id}</p>
                </div>
                <div className="text-right">
                  <p className="text-xs">Fecha de impresión: {new Date().toLocaleString()}</p>
                  {state.selectedSale && (
                    <p className="text-xs">Fecha de venta: {formatDate(state.selectedSale.created_at)}</p>
                  )}
                </div>
              </div>
            </div>
            <div className="print-body">
           <DialogHeader>
            <DialogTitle id="sale-details-title" className="flex items-center gap-2">
              <Receipt className="h-5 w-5" />
              Detalles de Venta #{state.selectedSale?.id}
            </DialogTitle>
            <DialogDescription>
              Información completa de la venta realizada el {state.selectedSale && formatDate(state.selectedSale.created_at)}
            </DialogDescription>
          </DialogHeader>
          
          {state.selectedSale && (
            <div className="space-y-6">
              {/* Información del Cliente */}
              <Collapsible open={customerInfoOpen} onOpenChange={setCustomerInfoOpen}>
                <Card>
                  <CollapsibleTrigger asChild>
                    <button
                      type="button"
                      aria-controls="customer-info-section"
                      aria-expanded={customerInfoOpen}
                      className="w-full"
                    >
                      <CardHeader className="cursor-pointer">
                        <div className="flex items-center justify-between">
                          <CardTitle className="flex items-center gap-2">
                            <User className="h-4 w-4" />
                            Información del Cliente
                          </CardTitle>
                          {customerInfoOpen ? (
                            <ChevronUp className="h-4 w-4" />
                          ) : (
                            <ChevronDown className="h-4 w-4" />
                          )}
                        </div>
                      </CardHeader>
                    </button>
                  </CollapsibleTrigger>
                  <CollapsibleContent>
                    <CardContent id="customer-info-section" className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="md:col-span-2 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <Avatar>
                            <AvatarFallback>
                              {((customerDetails?.name || state.selectedSale.customer?.name || 'C') as string)
                                .split(' ')
                                .map(p => p[0])
                                .join('')
                                .slice(0,2)
                                .toUpperCase()}
                            </AvatarFallback>
                          </Avatar>
                          <div>
                            <div className="flex items-center gap-2">
                              <span className="font-medium">
                                {customerDetails?.name || state.selectedSale.customer?.name || 'Cliente Anónimo'}
                              </span>
                              <Badge variant={(customerDetails?.customer_type === 'WHOLESALE' || (customerMetrics?.totalSpent || 0) > 1000) ? 'default' : 'secondary'}>
                                {customerDetails?.customer_type === 'WHOLESALE' ? 'Mayorista' : (customerMetrics?.totalSpent || 0) > 1000 ? 'VIP' : 'Regular'}
                              </Badge>
                            </div>
                            <div className="text-xs text-muted-foreground flex items-center gap-2">
                              <MapPin className="h-3 w-3" />
                              <span>{customerDetails?.address || 'Dirección no especificada'}</span>
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              const id = state.selectedSale?.customer_id;
                              if (id) {
                                window.location.href = `/dashboard/customers?id=${encodeURIComponent(String(id))}`;
                              }
                            }}
                          >
                            <ExternalLink className="h-4 w-4 mr-1" />
                            Ver cliente
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={async () => {
                              const id = state.selectedSale?.customer_id;
                              if (!id || !navigator.clipboard) return;
                              await navigator.clipboard.writeText(String(id));
                              toast({ title: 'Copiado', description: 'ID de cliente copiado al portapapeles' });
                            }}
                          >
                            <Copy className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            disabled={!customerDetails?.email && !state.selectedSale.customer?.email}
                            onClick={() => {
                          const email = customerDetails?.email || state.selectedSale?.customer?.email;
                              if (email) window.location.href = `mailto:${email}`;
                            }}
                          >
                            <Mail className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            disabled={!customerDetails?.phone && !state.selectedSale.customer?.phone}
                            onClick={() => {
                              const phone = customerDetails?.phone || state.selectedSale?.customer?.phone;
                              if (phone) window.location.href = `tel:${phone}`;
                            }}
                          >
                            <Phone className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                      {state.selectedSale?.customer_id && (
                        <div className="md:col-span-2">
                          <Label className="text-sm font-medium">Lealtad</Label>
                          <div className="mt-2">
                            <CustomerLoyaltyCard customerId={String(state.selectedSale.customer_id)} compact showActions={false} />
                          </div>
                        </div>
                      )}
                      <div>
                        <Label className="text-sm font-medium">Nombre</Label>
                        <p className="text-sm">{customerDetails?.name || state.selectedSale.customer?.name || 'Cliente Anónimo'}</p>
                      </div>
                      <div>
                        <Label className="text-xs text-muted-foreground">Email</Label>
                        <p className="text-sm">{customerDetails?.email || state.selectedSale.customer?.email || 'No especificado'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Teléfono</Label>
                        <p className="text-sm">{customerDetails?.phone || state.selectedSale.customer?.phone || 'No especificado'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">ID Cliente</Label>
                        <p className="text-sm">{state.selectedSale.customer_id || 'N/A'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Dirección</Label>
                        <p className="text-sm">{customerDetails?.address || 'No especificado'}</p>
                      </div>
                      <div className="flex items-center gap-2">
                        <div>
                          <Label className="text-sm font-medium">Tipo</Label>
                          <Badge variant={customerDetails?.customer_type === 'WHOLESALE' ? 'default' : 'secondary'} className="w-fit">
                            {customerDetails?.customer_type === 'WHOLESALE' ? 'Mayorista' : customerDetails?.customer_type === 'RETAIL' ? 'Minorista' : customerDetails?.customer_type || 'N/D'}
                          </Badge>
                        </div>
                        <div>
                          <Label className="text-sm font-medium">Estado</Label>
                          <Badge variant={customerDetails?.is_active ? 'default' : 'destructive'} className="w-fit">
                            {customerDetails?.is_active ? 'Activo' : 'Inactivo'}
                          </Badge>
                        </div>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Estado (detalle)</Label>
                        <p className="text-sm">{customerDetails?.status || 'N/D'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">RUC / NIT</Label>
                        <p className="text-sm">{customerDetails?.tax_id || 'No especificado'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Código de Cliente</Label>
                        <p className="text-sm">{customerDetails?.customer_code || 'N/D'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Órdenes</Label>
                        <p className="text-sm">{customerMetrics?.orderCount ?? (typeof customerDetails?.total_purchases === 'number' ? customerDetails.total_purchases : 0)}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Total Gastado</Label>
                        <p className="text-sm">{fmtCurrency(customerMetrics?.totalSpent || 0)}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Última Compra</Label>
                        <p className="text-sm">{customerMetrics?.lastOrderDate ? formatDate(customerMetrics.lastOrderDate) : (customerDetails?.last_purchase_date ? formatDate(customerDetails.last_purchase_date) : 'N/A')}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Descuento Mayorista</Label>
                        <p className="text-sm">{typeof customerDetails?.wholesale_discount === 'number' ? `${customerDetails.wholesale_discount}%` : 'N/A'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Mínimo para Mayorista</Label>
                        <p className="text-sm">{typeof customerDetails?.min_wholesale_quantity === 'number' ? customerDetails.min_wholesale_quantity : 'N/A'}</p>
                      </div>
                      <div>
                        <Label className="text-sm font-medium">Fecha de Nacimiento</Label>
                        <p className="text-sm">{customerDetails?.birth_date ? formatDate(customerDetails.birth_date) : 'No especificado'}</p>
                      </div>
                      <div className="md:col-span-2">
                        <Label className="text-sm font-medium">Notas</Label>
                        <p className="text-sm">{customerDetails?.notes || 'Sin notas'}</p>
                      </div>
                    </CardContent>
                  </CollapsibleContent>
                </Card>
              </Collapsible>

              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <ShoppingCart className="h-4 w-4" />
                    Detalles de la Compra
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div id="purchase-details-section" className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label className="text-sm font-medium">ID Venta</Label>
                      <p className="text-sm">{state.selectedSale.id}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Cajero</Label>
                      <p className="text-sm">{state.selectedSale.user?.name || state.selectedSale.user_id || 'N/D'}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Tipo de Venta</Label>
                      <p className="text-sm">{state.selectedSale.sale_type === 'WHOLESALE' ? 'Mayorista' : 'Minorista'}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Impuesto (%)</Label>
                      <p className="text-sm">{(() => {
                        const subtotal = (state.selectedSale.total_amount - state.selectedSale.tax_amount - (state.selectedSale.discount_amount || 0)) || 0;
                        const pct = subtotal > 0 ? (state.selectedSale.tax_amount / subtotal) * 100 : 0;
                        return `${pct.toFixed(2)}%`;
                      })()}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Método de Pago</Label>
                      <p className="text-sm">{
                        state.selectedSale.payment_method === 'CASH' ? 'Efectivo' :
                        state.selectedSale.payment_method === 'CARD' ? 'Tarjeta' :
                        state.selectedSale.payment_method === 'TRANSFER' ? 'Transferencia' : 'Otro'
                      }</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Estado</Label>
                      <p className="text-sm">{
                        state.selectedSale.status === 'COMPLETED' ? 'Completada' :
                        state.selectedSale.status === 'PENDING' ? 'Pendiente' :
                        state.selectedSale.status === 'CANCELLED' ? 'Cancelada' : 'Reembolsada'
                      }</p>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Productos */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Package className="h-4 w-4" />
                    Productos ({state.selectedSale.items?.length || 0})
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {state.selectedSale.items && state.selectedSale.items.length > 0 ? (
                      state.selectedSale.items.map((item, index) => (
                        <div key={index} className="flex justify-between items-center p-3 border rounded-lg">
                          <div className="flex-1">
                            <h4 className="font-medium">{item.product?.name || 'Producto sin nombre'}</h4>
                            <p className="text-sm text-muted-foreground">SKU: {item.product?.sku || item.product_id || 'N/A'}</p>
                          </div>
                          <div className="text-center">
                            <p className="text-sm text-muted-foreground">Cantidad</p>
                            <p className="font-medium">{item.quantity}</p>
                          </div>
                          <div className="text-center">
                            <p className="text-sm text-muted-foreground">Precio Unit.</p>
                            <p className="font-medium">{fmtCurrency(item.unit_price)}</p>
                          </div>
                          <div className="text-right">
                            <p className="text-sm text-muted-foreground">Subtotal</p>
                            <p className="font-bold">{fmtCurrency(item.quantity * item.unit_price)}</p>
                          </div>
                        </div>
                      ))
                    ) : (
                      <p className="text-muted-foreground text-center py-4">No hay productos en esta venta</p>
                    )}
                  </div>
                </CardContent>
              </Card>

              {/* Resumen de Pago */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <DollarSign className="h-4 w-4" />
                    Resumen de Pago
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex justify-between">
                      <span>Subtotal:</span>
                      <span>{fmtCurrency((state.selectedSale.total_amount - state.selectedSale.tax_amount - (state.selectedSale.discount_amount || 0)) || 0)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Impuestos:</span>
                      <span>{fmtCurrency(state.selectedSale.tax_amount || 0)}</span>
                    </div>
                    {state.selectedSale.discount_amount > 0 && (
                      <div className="flex justify-between text-red-600">
                        <span>Descuento{state.selectedSale.discount_type ? ` (${state.selectedSale.discount_type === 'PERCENTAGE' ? '%' : 'Monto'})` : ''}:</span>
                        <span>-{fmtCurrency(state.selectedSale.discount_amount)}</span>
                      </div>
                    )}
                    {state.selectedSale.coupon_code && (
                      <div className="flex justify-between text-xs text-muted-foreground">
                        <span>Cupón aplicado:</span>
                        <span>{state.selectedSale.coupon_code}</span>
                      </div>
                    )}
                    <Separator />
                    <div className="flex justify-between text-lg font-bold">
                      <span>Total:</span>
                      <span className="text-green-600">{fmtCurrency(state.selectedSale.total_amount)}</span>
                    </div>
                    <div className="flex items-center gap-2 mt-4">
                      <Badge variant="outline" className="flex items-center gap-1">
                        {state.selectedSale.payment_method === 'CASH' && <Banknote className="h-3 w-3" />}
                        {state.selectedSale.payment_method === 'CARD' && <CreditCard className="h-3 w-3" />}
                        {state.selectedSale.payment_method === 'TRANSFER' && <Smartphone className="h-3 w-3" />}
                        Método: {state.selectedSale.payment_method === 'CASH' ? 'Efectivo' : 
                                 state.selectedSale.payment_method === 'CARD' ? 'Tarjeta' : 'Transferencia'}
                      </Badge>
                      <Badge 
                        variant={
                          state.selectedSale.status === 'COMPLETED' ? 'default' : 
                          state.selectedSale.status === 'PENDING' ? 'secondary' : 'destructive'
                        }
                        className="flex items-center gap-1"
                      >
                        {state.selectedSale.status === 'COMPLETED' && <CheckCircle2 className="h-3 w-3" />}
                        {state.selectedSale.status === 'PENDING' && <AlertCircle className="h-3 w-3" />}
                        {state.selectedSale.status === 'CANCELLED' && <XCircle className="h-3 w-3" />}
                        Estado: {state.selectedSale.status === 'COMPLETED' ? 'Completada' : 
                                 state.selectedSale.status === 'PENDING' ? 'Pendiente' : 'Cancelada'}
                      </Badge>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Notas */}
              {state.selectedSale.notes && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <FileText className="h-4 w-4" />
                      Notas
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-sm">{state.selectedSale.notes}</p>
                  </CardContent>
                </Card>
              )}

              {/* Acciones */}
              <div className="flex justify-end gap-2">
                <Button
                  variant="outline"
                  onClick={() => {
                    // Imprimir solo la sección del detalle de venta
                    window.print();
                  }}
                >
                  <Printer className="h-4 w-4 mr-2" />
                  Imprimir
                </Button>
                <Button
                  variant="outline"
                  onClick={() => {
                    // Unificar exportación: cerrar modal y hacer scroll al widget central
                    setState(prev => ({ ...prev, showSaleModal: false }));
                    const el = document.getElementById('sales-export-widget');
                    if (el) {
                      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      toast({ title: 'Exportación', description: 'Usa el módulo de exportación para elegir formato y opciones.' });
                    } else {
                      toast({ title: 'Exportación', description: 'No se encontró el módulo de exportación.', variant: 'destructive' });
                    }
                  }}
                >
                  <Download className="h-4 w-4 mr-2" />
                  Exportar
                </Button>
              </div>
            </div>
          )}
          </div>
           <div className="print-only print-footer">
             <div className="flex justify-between">
               <span>Sistema de Inventario POS</span>
               <span>Página <span className="page"></span> de <span className="pages"></span></span>
             </div>
           </div>
          </div>
          </DialogContent>
      </Dialog>
      </ErrorBoundary>
    </div>
    </PermissionProvider>
  );
}

const SalesChartsLazy = dynamic(() => import('@/components/dashboard/SalesCharts'), {
  ssr: false,
  loading: () => <Skeleton className="h-40 w-full" />
});

const SalesAnalyticsLazy = dynamic(() => import('@/components/dashboard/SalesAnalytics'), {
  ssr: false,
  loading: () => <Skeleton className="h-40 w-full" />
});

const SalesExportLazy = dynamic(() => import('@/components/dashboard/SalesExport'), {
  ssr: false
});
