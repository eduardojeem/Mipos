'use client';

import React, { useMemo, useState, useEffect, useCallback } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import { Collapsible, CollapsibleTrigger, CollapsibleContent } from '@/components/ui/collapsible';
import { Switch } from '@/components/ui/switch';
import { useCurrencyFormatter } from '@/contexts/BusinessConfigContext';
import { calculateCartWithIva, type DiscountType, getFreeShippingThreshold } from '@/lib/pos/calculations';
import { composeDiscounts, discountBreakdown } from '@/lib/pos/discounts';
import { validateDiscount } from '@/lib/pos/validation';
import { useConfirmationDialog } from '@/components/ui/confirmation-dialog';
import type { Product, Customer } from '@/types';
import { PaymentMethod } from '@/types';
import type { CartItem } from '@/hooks/useCart';
import { AlertTriangle, CheckCircle, Percent, DollarSign, Receipt, ShoppingCart, Package2, CreditCard, Smartphone, Banknote, Wallet, QrCode, Truck, Trash2, Tag } from 'lucide-react';
import { useBusinessConfig } from '@/contexts/BusinessConfigContext';
import { usePOSStore } from '@/store';
import { StepIndicator, type Step } from './StepIndicator';
import { SaleSummaryHeader } from './SaleSummaryHeader';
import { cn } from '@/lib/utils';

interface ProcessSaleModalProps {
  isOpen: boolean;
  onClose: () => void;
  cart: CartItem[];
  products: Product[];
  initialDiscount: number;
  initialDiscountType: DiscountType;
  onConfirm: (discount: number, discountType: DiscountType) => Promise<void> | void;
  customer?: Customer | null;
  paymentMethod?: PaymentMethod;
  // Enhanced props
  onPaymentMethodChange?: (method: PaymentMethod) => void;
  enableSplitPayment?: boolean;
  enableQuickPayment?: boolean;
  onRemoveItem?: (productId: string) => void;
}

export default function ProcessSaleModal({
  isOpen,
  onClose,
  cart,
  products,
  initialDiscount,
  initialDiscountType,
  onConfirm,
  customer,
  paymentMethod,
  onPaymentMethodChange,
  enableSplitPayment = false,
  enableQuickPayment = true,
  onRemoveItem,
}: ProcessSaleModalProps) {
  const fmtCurrency = useCurrencyFormatter();
  const [discount, setDiscount] = useState<number>(initialDiscount ?? 0);
  const [discountType, setDiscountType] = useState<DiscountType>(initialDiscountType ?? 'PERCENTAGE');
  const [errors, setErrors] = useState<string[]>([]);
  const [touched, setTouched] = useState<{ discount: boolean; type: boolean }>({ discount: false, type: false });
  type DiscountEntry = { id: string; type: DiscountType; value: number };
  const [discountEntries, setDiscountEntries] = useState<DiscountEntry[]>([]);
  const [couponApplied, setCouponApplied] = useState<{ amount: number; type: DiscountType } | null>(null);
  const [cashReceived, setCashReceived] = useState<number>(0);
  const [cashInput, setCashInput] = useState<string>('');
  const [shippingCost, setShippingCost] = useState<number>(0);
  const [shippingInput, setShippingInput] = useState<string>('');
  const [shippingRegion, setShippingRegion] = useState<string>('General');
  const [shippingOpen, setShippingOpen] = useState<boolean>(true);
  const [shippingEnabled, setShippingEnabled] = useState<boolean>(false);
  const [shippingAddress, setShippingAddress] = useState<{ street: string; neighborhood: string; city: string; department: string }>({ street: '', neighborhood: '', city: '', department: '' });
  // Enhanced payment states
  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState<PaymentMethod>(paymentMethod || PaymentMethod.CASH);
  const [splitPaymentEnabled, setSplitPaymentEnabled] = useState(false);
  const [splitPayments, setSplitPayments] = useState<Array<{ method: PaymentMethod; amount: number }>>([]);
  const [quickPaymentMode, setQuickPaymentMode] = useState(false);
  const { config } = useBusinessConfig();
  const setCouponData = usePOSStore((s) => s.setCouponData);
  const clearCoupon = usePOSStore((s) => s.clearCoupon);
  const couponCodeStore = usePOSStore((s) => s.couponCode);
  const globalNotes = usePOSStore((s) => s.notes);
  const setGlobalNotes = usePOSStore((s) => s.setNotes);
  const [localNotes, setLocalNotes] = useState<string>(globalNotes || '');
  const [couponCode, setCouponCode] = useState<string>('');
  const [couponLoading, setCouponLoading] = useState(false);

  // Step navigation state
  const [currentStep, setCurrentStep] = useState(1);

  // Define steps
  const SALE_STEPS: Step[] = [
    { id: 1, title: 'Productos', icon: ShoppingCart },
    { id: 2, title: 'Descuentos', icon: Percent, optional: true },
    { id: 3, title: 'Pago', icon: CreditCard },
    { id: 4, title: 'Confirmar', icon: CheckCircle }
  ];

  const applyCoupon = async () => {
    if (!couponCode) return;
    try {
      setCouponLoading(true);
      const res = await fetch('/api/coupons/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: couponCode, subtotal: Number(totals.subtotalWithIva) || 0 })
      });
      if (!res.ok) throw new Error(`Error ${res.status}`);
      const data = await res.json();
      const { discountAmount, discountType } = data;
      setCouponData(couponCode, discountAmount, discountType);
      setDiscountType(discountType);
      setDiscount(discountType === 'PERCENTAGE' ? Number(discountAmount) : Number(discountAmount));
      setCouponApplied({ amount: Number(discountAmount), type: discountType });
    } catch (e: any) {
      setErrors([e?.message || 'Cupón inválido']);
    } finally {
      setCouponLoading(false);
    }
  };

  const removeCoupon = () => {
    try { clearCoupon(); } catch { }
    setCouponCode('');
    setCouponApplied(null);
  };

  const baseTotals = useMemo(() => calculateCartWithIva(cart, products, 0, 'FIXED_AMOUNT'), [cart, products]);
  const composedDiscountTotal = useMemo(() => {
    const entries: Array<{ type: DiscountType; value: number }> = [];
    if (Number(discount) > 0) entries.push({ type: discountType, value: Number(discount) });
    for (const e of discountEntries) {
      if (Number(e.value) > 0) entries.push({ type: e.type, value: Number(e.value) });
    }
    if (couponApplied && Number(couponApplied.amount) > 0) entries.push({ type: couponApplied.type, value: Number(couponApplied.amount) });
    return composeDiscounts(Number(baseTotals.subtotalWithIva) || 0, entries);
  }, [baseTotals.subtotalWithIva, discount, discountType, discountEntries, couponApplied]);
  const breakdown = useMemo(() => {
    const entries: Array<{ type: DiscountType; value: number }> = [];
    if (Number(discount) > 0) entries.push({ type: discountType, value: Number(discount) });
    for (const e of discountEntries) {
      if (Number(e.value) > 0) entries.push({ type: e.type, value: Number(e.value) });
    }
    if (couponApplied && Number(couponApplied.amount) > 0) entries.push({ type: couponApplied.type, value: Number(couponApplied.amount) });
    return discountBreakdown(Number(baseTotals.subtotalWithIva) || 0, entries);
  }, [baseTotals.subtotalWithIva, discount, discountType, discountEntries, couponApplied]);
  const totals = useMemo(() => calculateCartWithIva(cart, products, Number(composedDiscountTotal) || 0, 'FIXED_AMOUNT'), [cart, products, composedDiscountTotal]);

  const modified = useMemo(() => {
    return (Number(discount) !== Number(initialDiscount)) || (discountType !== initialDiscountType);
  }, [discount, discountType, initialDiscount, initialDiscountType]);
  const insufficientStockItems = useMemo(() => {
    return cart
      .map((item) => {
        const productDetails = products.find(p => String(p.id) === String(item.product_id));
        const available = Number(productDetails?.stock_quantity ?? 0);
        return available < Number(item.quantity) ? { id: item.product_id, name: item.product_name, requested: item.quantity, available } : null;
      })
      .filter(Boolean) as Array<{ id: string; name: string; requested: number; available: number }>;
  }, [cart, products]);

  useEffect(() => {
    // Reset errors when input changes
    setErrors([]);
  }, [discount, discountType]);

  // Reset efectivo recibido al abrir/cerrar o cuando cambia el total
  useEffect(() => {
    if (!isOpen) {
      setCashReceived(0);
      setCashInput('');
      setSelectedPaymentMethod(paymentMethod || PaymentMethod.CASH);
      setSplitPaymentEnabled(false);
      setSplitPayments([]);
      setQuickPaymentMode(false);
    }
  }, [isOpen, paymentMethod]);

  const finalTotals = useMemo(() => {
    const threshold = getFreeShippingThreshold(config, shippingRegion);
    const isFreeShipping = threshold > 0 && Number(totals.subtotalWithIva) >= threshold;
    const appliedShipping = shippingEnabled ? (isFreeShipping ? 0 : Math.max(0, Number(shippingCost) || 0)) : 0;
    const grandTotal = Number(totals.total) + Number(appliedShipping);
    return { threshold, isFreeShipping, appliedShipping, grandTotal };
  }, [config, totals.subtotalWithIva, totals.total, shippingCost, shippingRegion, shippingEnabled]);

  const changeDue = useMemo(() => {
    const change = Number(cashReceived) - Number(finalTotals.grandTotal);
    return Number.isFinite(change) ? Math.max(0, change) : 0;
  }, [cashReceived, finalTotals.grandTotal]);

  // Validaciones (compartidas)
  const validate = () => {
    const errs: string[] = [];
    // Validación del primer descuento clásico
    errs.push(...validateDiscount(Number(discount) || 0, discountType, baseTotals.subtotalWithIva));
    // Validación de entradas adicionales
    for (const [idx, e] of discountEntries.entries()) {
      const localErrs = validateDiscount(Number(e.value) || 0, e.type, baseTotals.subtotalWithIva);
      for (const msg of localErrs) errs.push(`Desc. ${idx + 1}: ${msg}`);
    }
    // Validación de cupón (si existe valor local)
    if (couponApplied && Number(couponApplied.amount) > 0) {
      const cupErrs = validateDiscount(Number(couponApplied.amount) || 0, couponApplied.type, baseTotals.subtotalWithIva);
      for (const msg of cupErrs) errs.push(`Cupón: ${msg}`);
    }
    if (shippingEnabled) {
      const reqs: Array<{ key: keyof typeof shippingAddress; label: string }> = [
        { key: 'street', label: 'Dirección' },
        { key: 'neighborhood', label: 'Barrio' },
        { key: 'city', label: 'Ciudad' },
        { key: 'department', label: 'Departamento' },
      ];
      for (const r of reqs) {
        const v = String((shippingAddress as any)[r.key] || '').trim();
        if (!v) errs.push(`Campo de envío requerido: ${r.label}`);
      }
    }
    setErrors(errs);
    return errs.length === 0;
  };

  const { showConfirmation, ConfirmationDialog, isLoading } = useConfirmationDialog();

  const handleConfirmClick = () => {
    // Run validations first
    if (!validate()) return;
    if (insufficientStockItems.length > 0) {
      setErrors([`Inventario insuficiente para ${insufficientStockItems.map(i => i.name).join(', ')}`]);
      return;
    }

    // Validar pago en efectivo si corresponde
    if (selectedPaymentMethod === PaymentMethod.CASH && !splitPaymentEnabled) {
      const received = Number(cashReceived) || 0;
      if (received < Number(finalTotals.grandTotal)) {
        setErrors([`Efectivo insuficiente: falta ${fmtCurrency(Number(finalTotals.grandTotal) - received)}`]);
        return;
      }
    }

    // Validar pagos divididos
    if (splitPaymentEnabled) {
      const totalSplit = splitPayments.reduce((sum, payment) => sum + payment.amount, 0);
      if (Math.abs(totalSplit - Number(finalTotals.grandTotal)) > 0.01) {
        setErrors([`El total de pagos divididos debe ser igual al total: ${fmtCurrency(finalTotals.grandTotal)}`]);
        return;
      }
    }

    const paymentDescription = splitPaymentEnabled
      ? `Pago dividido: ${splitPayments.map(p => `${p.method} ${fmtCurrency(p.amount)}`).join(', ')}`
      : `Pago con ${selectedPaymentMethod === PaymentMethod.CASH ? 'efectivo' : selectedPaymentMethod === PaymentMethod.CARD ? 'tarjeta' : selectedPaymentMethod === PaymentMethod.TRANSFER ? 'transferencia' : 'otro método'}`;

    showConfirmation({
      title: 'Confirmar procesamiento de venta',
      description: `Se aplicará descuento total de ${fmtCurrency(composedDiscountTotal)}. ${paymentDescription}. Total a pagar: ${fmtCurrency(finalTotals.grandTotal)}${selectedPaymentMethod === PaymentMethod.CASH && !splitPaymentEnabled ? ` • Cambio: ${fmtCurrency(changeDue)}` : ''}. ¿Deseas continuar?`,
      confirmText: 'Confirmar',
      cancelText: 'Cancelar',
      variant: 'info',
      onConfirm: async () => {
        // Update payment method if changed
        if (onPaymentMethodChange && selectedPaymentMethod !== paymentMethod) {
          onPaymentMethodChange(selectedPaymentMethod);
        }
        try {
          const sanitized = (localNotes || '').replace(/<\/?script[^>]*>/gi, '').slice(0, 1000);
          setGlobalNotes(sanitized);
        } catch { }
        await onConfirm(Number(composedDiscountTotal) || 0, 'FIXED_AMOUNT');
      },
    });
  };

  const handleClear = () => {
    setDiscount(0);
    setDiscountType('PERCENTAGE');
    setTouched({ discount: false, type: false });
    setErrors([]);
    setCashReceived(0);
    setCashInput('');
    setSelectedPaymentMethod(paymentMethod || PaymentMethod.CASH);
    setSplitPaymentEnabled(false);
    setSplitPayments([]);
    setQuickPaymentMode(false);
    setDiscountEntries([]);
    setCouponApplied(null);
    setCouponCode('');
  };

  // Atajos de teclado dentro del modal
  const onKeyDown = useCallback((e: KeyboardEvent) => {
    if (!isOpen) return;
    // Evitar capturar cuando se escribe en inputs de texto/numero
    const target = e.target as HTMLElement | null;
    const tag = (target?.tagName || '').toLowerCase();
    const isInput = tag === 'input' || tag === 'textarea' || (target as any)?.isContentEditable;
    if (isInput) {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleConfirmClick();
      }
      return;
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      onClose();
    }
    // F9: monto exacto
    if (e.key === 'F9') {
      e.preventDefault();
      setCashReceived(Number(totals.total));
    }
  }, [isOpen, totals.total, onClose]);

  useEffect(() => {
    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [onKeyDown]);

  // Helpers para teclado numérico y redondeo
  const setCashExact = useCallback(() => {
    const v = Number(finalTotals.grandTotal);
    setCashReceived(v);
    setCashInput(v.toFixed(2));
  }, [finalTotals.grandTotal]);

  useEffect(() => {
    if (!shippingEnabled) return;
    const threshold = getFreeShippingThreshold(config, shippingRegion);
    const subtotal = Number(totals.subtotalWithIva) || 0;
    if (threshold > 0 && subtotal >= threshold) {
      setShippingCost(0);
      setShippingInput('0');
    } else {
      const auto = Math.round(subtotal * 0.02);
      setShippingCost(auto);
      setShippingInput(String(auto));
    }
  }, [shippingEnabled, shippingRegion, totals.subtotalWithIva, config]);

  const appendCash = useCallback((s: string) => {
    const current = cashInput || '';
    if (s === '.') {
      if (current.includes('.') || current.includes(',')) return;
      const next = (current || '0') + '.';
      setCashInput(next);
      return;
    }
    const next = current + s;
    if (next.length > 18) return;
    setCashInput(next);
    const num = Number(next.replace(',', '.'));
    if (!Number.isNaN(num)) setCashReceived(num);
  }, [cashInput]);

  const backspaceCash = useCallback(() => {
    const next = (cashInput || '').slice(0, -1);
    setCashInput(next);
    const num = Number(next.replace(',', '.'));
    setCashReceived(Number.isNaN(num) ? 0 : num);
  }, [cashInput]);

  const clearCash = useCallback(() => {
    setCashInput('');
    setCashReceived(0);
  }, []);

  const roundTo = useCallback((unit: number) => {
    const rounded = Math.ceil(Number(finalTotals.grandTotal) / unit) * unit;
    setCashInput(rounded.toFixed(2));
    setCashReceived(rounded);
  }, [finalTotals.grandTotal]);

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-2xl">
            <Receipt className="h-6 w-6 text-primary" />
            Procesar Venta
          </DialogTitle>
          <DialogDescription>
            Revisa los detalles, ajusta descuentos si es necesario y confirma la venta.
          </DialogDescription>
        </DialogHeader>

        {/* Step Indicator */}
        <StepIndicator steps={SALE_STEPS} currentStep={currentStep} className="my-6" />

        {/* Sticky Summary Header */}
        <SaleSummaryHeader
          totalAmount={finalTotals.grandTotal}
          itemCount={cart.length}
          discountAmount={composedDiscountTotal}
          paymentMethod={
            selectedPaymentMethod === PaymentMethod.CASH ? 'Efectivo' :
              selectedPaymentMethod === PaymentMethod.CARD ? 'Tarjeta' :
                selectedPaymentMethod === PaymentMethod.TRANSFER ? 'Transferencia' :
                  selectedPaymentMethod === PaymentMethod.OTHER ? 'Otro' : undefined
          }
          formatCurrency={fmtCurrency}
          className="mb-6"
        />

        <div className="space-y-6">
          {/* Sale Details Section */}
          <Card className="animate-in fade-in-50">
            <CardHeader>
              <CardTitle className="text-lg">Detalles de venta</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {cart.length === 0 ? (
                  <div className="flex items-center gap-2 p-3 rounded-md bg-muted/40 text-sm text-muted-foreground">
                    <ShoppingCart className="h-4 w-4" />
                    <span>No hay productos en el carrito. Agrega productos para procesar la venta.</span>
                  </div>
                ) : (
                  cart.map((item, idx) => {
                    const productDetails = products.find(p => String(p.id) === String(item.product_id));
                    const hasPromo = !!(productDetails?.discount_percentage && productDetails.discount_percentage > 0);
                    const available = Number(productDetails?.stock_quantity ?? 0);
                    const insufficient = available < Number(item.quantity);
                    return (
                      <div key={`${item.product_id} -${idx} `} className="flex items-center justify-between py-2 border-b last:border-0">
                        <div className="flex items-center gap-3 min-w-0 flex-1">
                          <div className="w-10 h-10 rounded-md overflow-hidden bg-muted flex items-center justify-center flex-shrink-0">
                            {productDetails?.image_url ? (
                              <img src={productDetails.image_url} alt={item.product_name} className="w-full h-full object-cover" />
                            ) : (
                              <Package2 className="h-5 w-5 text-muted-foreground" />
                            )}
                          </div>
                          <div className="min-w-0">
                            <div className="flex items-center gap-2">
                              <div className="font-medium truncate">{item.product_name}</div>
                              {hasPromo && (
                                <Badge variant="secondary" className="text-[10px] px-1.5 py-0.5 bg-red-100 text-red-700">Promoción</Badge>
                              )}
                              {insufficient && (
                                <Badge variant="destructive" className="text-[10px] px-1.5 py-0.5">Stock insuficiente</Badge>
                              )}
                            </div>
                            <div className="text-xs text-muted-foreground">Cantidad: {item.quantity}</div>
                            {insufficient && (
                              <div className="text-xs text-destructive">Disponible: {available}</div>
                            )}
                          </div>
                        </div>
                        <div className="w-24 text-right">
                          <div className="text-sm">{fmtCurrency(item.price)}</div>
                          <div className="text-xs text-muted-foreground">Unitario</div>
                        </div>
                        <div className="w-28 text-right">
                          <div className="text-sm font-semibold">{fmtCurrency(item.total)}</div>
                          <div className="text-xs text-muted-foreground">Total</div>
                        </div>
                        <div className="w-10 text-right">
                          <Button
                            variant="ghost"
                            size="icon"
                            aria-label="Eliminar producto"
                            onClick={() => {
                              showConfirmation({
                                title: 'Eliminar producto',
                                description: '¿Está seguro de eliminar este producto?',
                                confirmText: 'Eliminar',
                                cancelText: 'Cancelar',
                                variant: 'destructive',
                                onConfirm: async () => {
                                  if (typeof onRemoveItem === 'function') {
                                    try { onRemoveItem(item.product_id); } catch { }
                                    try {
                                      await fetch('/api/admin/audit', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                          event: 'pos.cart.remove',
                                          meta: {
                                            entityType: 'SALE_CART',
                                            entityId: item.product_id,
                                            productName: item.product_name,
                                            quantity: item.quantity,
                                            customerId: customer?.id || null
                                          }
                                        })
                                      });
                                    } catch { }
                                  }
                                }
                              });
                            }}
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>

              <Separator className="my-4" />

              {/* Totals Summary (before discounts) */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <p className="text-muted-foreground">Subtotal (con IVA)</p>
                  <p className="font-medium">{fmtCurrency(totals.subtotalWithIva)}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">IVA</p>
                  <p className="font-medium">{fmtCurrency(totals.taxAmount)}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">Descuento actual</p>
                  <p className="font-medium">{fmtCurrency(totals.discountAmount)}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">Envío</p>
                  <p className="font-medium">{finalTotals.isFreeShipping || !shippingEnabled ? 'Gratis' : fmtCurrency(finalTotals.appliedShipping)}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">TOTAL (con envío)</p>
                  <p className="font-bold text-primary">{fmtCurrency(finalTotals.grandTotal)}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Payment Method Selection */}
          <Card className="animate-in fade-in-50">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <CreditCard className="h-5 w-5" />
                Paso 2 · Método de pago
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <Button
                  type="button"
                  variant={selectedPaymentMethod === PaymentMethod.CASH ? 'default' : 'outline'}
                  onClick={() => setSelectedPaymentMethod(PaymentMethod.CASH)}
                  className="flex flex-col items-center gap-2 h-16"
                >
                  <Banknote className="h-6 w-6" />
                  <span className="text-xs">Efectivo</span>
                </Button>
                <Button
                  type="button"
                  variant={selectedPaymentMethod === PaymentMethod.CARD ? 'default' : 'outline'}
                  onClick={() => setSelectedPaymentMethod(PaymentMethod.CARD)}
                  className="flex flex-col items-center gap-2 h-16"
                >
                  <CreditCard className="h-6 w-6" />
                  <span className="text-xs">Tarjeta</span>
                </Button>
                <Button
                  type="button"
                  variant={selectedPaymentMethod === PaymentMethod.TRANSFER ? 'default' : 'outline'}
                  onClick={() => setSelectedPaymentMethod(PaymentMethod.TRANSFER)}
                  className="flex flex-col items-center gap-2 h-16"
                >
                  <QrCode className="h-6 w-6" />
                  <span className="text-xs">Transferencia</span>
                </Button>
                <Button
                  type="button"
                  variant={selectedPaymentMethod === PaymentMethod.OTHER ? 'default' : 'outline'}
                  onClick={() => setSelectedPaymentMethod(PaymentMethod.OTHER)}
                  className="flex flex-col items-center gap-2 h-16"
                >
                  <Wallet className="h-6 w-6" />
                  <span className="text-xs">Otro</span>
                </Button>
              </div>

              {/* Split Payment Toggle */}
              {enableSplitPayment && (
                <div className="mt-4 pt-4 border-t">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <Smartphone className="h-4 w-4" />
                      <span className="text-sm font-medium">Pago dividido</span>
                    </div>
                    <Button
                      type="button"
                      variant={splitPaymentEnabled ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => setSplitPaymentEnabled(!splitPaymentEnabled)}
                    >
                      {splitPaymentEnabled ? 'Activado' : 'Activar'}
                    </Button>
                  </div>
                  {splitPaymentEnabled && (
                    <div className="mt-3 space-y-3">
                      {splitPayments.map((p, idx) => (
                        <div key={`${p.method} -${idx} `} className="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                          <Select value={p.method as any} onValueChange={(val) => setSplitPayments((list) => list.map((it, i) => i === idx ? { ...it, method: val as any } : it))}>
                            <SelectTrigger className="h-10">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value={PaymentMethod.CASH as any}>Efectivo</SelectItem>
                              <SelectItem value={PaymentMethod.CARD as any}>Tarjeta</SelectItem>
                              <SelectItem value={PaymentMethod.TRANSFER as any}>Transferencia</SelectItem>
                              <SelectItem value={PaymentMethod.OTHER as any}>Otro</SelectItem>
                            </SelectContent>
                          </Select>
                          <Input
                            type="number"
                            inputMode="decimal"
                            min={0}
                            step="0.01"
                            value={p.amount}
                            onChange={(e) => {
                              const v = Number(e.target.value);
                              setSplitPayments((list) => list.map((it, i) => i === idx ? { ...it, amount: Number.isNaN(v) ? 0 : v } : it));
                            }}
                            className="h-10 md:col-span-2"
                          />
                          <div className="md:col-span-3 flex justify-end">
                            <Button type="button" variant="ghost" size="sm" onClick={() => setSplitPayments((list) => list.filter((_, i) => i !== idx))}>Quitar</Button>
                          </div>
                        </div>
                      ))}
                      <div className="flex items-center justify-between">
                        <Button type="button" variant="outline" size="sm" onClick={() => setSplitPayments((list) => [...list, { method: PaymentMethod.CASH, amount: 0 }])}>Agregar pago</Button>
                        <div className="text-xs text-muted-foreground">Total: {fmtCurrency(splitPayments.reduce((s, it) => s + Number(it.amount || 0), 0))} / {fmtCurrency(finalTotals.grandTotal)}</div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Cash Section (solo para efectivo) */}
          {selectedPaymentMethod === PaymentMethod.CASH && !splitPaymentEnabled && (
            <Card className="animate-in fade-in-50">
              <CardHeader>
                <CardTitle className="text-lg">Cobro en efectivo</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                  <div className="space-y-1">
                    <Label htmlFor="cash-received">Efectivo recibido</Label>
                    <Input
                      id="cash-received"
                      type="text"
                      inputMode="decimal"
                      min={0}
                      step="0.01"
                      value={cashInput}
                      onChange={(e) => {
                        const val = e.target.value;
                        setCashInput(val);
                        const num = Number(val.replace(',', '.'));
                        setCashReceived(Number.isNaN(num) ? 0 : num);
                      }}
                      className="h-10"
                    />
                    <div className="text-xs text-muted-foreground">Atajos: Enter confirmar • Esc cancelar • F9 exacto</div>
                  </div>
                  <div className="space-y-1">
                    <Label>Cambio</Label>
                    <div className="h-10 flex items-center justify-between rounded-md border bg-muted px-3">
                      <div className="text-sm text-muted-foreground">A devolver</div>
                      <div className="text-base font-bold">{fmtCurrency(changeDue)}</div>
                    </div>
                  </div>
                  <div className="space-y-1">
                    <Label>Accesos rápidos</Label>
                    <div className="flex flex-wrap gap-2">
                      <Button type="button" variant="secondary" onClick={setCashExact}>Exacto</Button>
                      <Button type="button" variant="outline" onClick={() => { const v = Number(totals.total) + 10; setCashInput(v.toFixed(2)); setCashReceived(v); }}>+10</Button>
                      <Button type="button" variant="outline" onClick={() => { const v = Number(totals.total) + 20; setCashInput(v.toFixed(2)); setCashReceived(v); }}>+20</Button>
                      <Button type="button" variant="outline" onClick={() => { const v = Number(totals.total) + 50; setCashInput(v.toFixed(2)); setCashReceived(v); }}>+50</Button>
                      <Button type="button" variant="default" onClick={() => roundTo(10)}>Redondear a 10</Button>
                      <Button type="button" variant="default" onClick={() => roundTo(100)}>Redondear a 100</Button>
                    </div>
                  </div>
                </div>

                {/* Teclado numérico compacto */}
                <div className="grid grid-cols-4 gap-2 mt-4 sm:max-w-md">
                  <Button type="button" variant="outline" onClick={() => appendCash('7')}>7</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('8')}>8</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('9')}>9</Button>
                  <Button type="button" variant="destructive" onClick={backspaceCash}>←</Button>

                  <Button type="button" variant="outline" onClick={() => appendCash('4')}>4</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('5')}>5</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('6')}>6</Button>
                  <Button type="button" variant="secondary" onClick={clearCash}>C</Button>

                  <Button type="button" variant="outline" onClick={() => appendCash('1')}>1</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('2')}>2</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('3')}>3</Button>
                  <Button type="button" variant="secondary" onClick={setCashExact}>Exacto</Button>

                  <Button type="button" variant="outline" onClick={() => appendCash('0')}>0</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('00')}>00</Button>
                  <Button type="button" variant="outline" onClick={() => appendCash('.')}>.</Button>
                  <div />
                </div>
              </CardContent>
            </Card>
          )}

          {/* Coupon Section */}
          <Card className="animate-in fade-in-50">
            <CardHeader>
              <CardTitle className="text-lg">Cupón</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div className="md:col-span-2 space-y-1">
                  <Label htmlFor="coupon-code">Código de cupón</Label>
                  <Input id="coupon-code" type="text" value={couponCode} onChange={(e) => setCouponCode(e.target.value)} placeholder="Ej: PROMO10" />
                  {couponCodeStore && (
                    <div className="text-xs text-green-600">Cupón aplicado: {couponCodeStore}</div>
                  )}
                </div>
                <div className="flex items-end gap-2">
                  <Button type="button" variant="default" onClick={applyCoupon} disabled={couponLoading || !couponCode}>Aplicar</Button>
                  <Button type="button" variant="ghost" onClick={removeCoupon} disabled={!couponCodeStore}>Quitar</Button>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Discount Section (multi-descuentos, responsive) */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Paso 1 · Descuentos</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                  <div className={`space - y - 1`}>
                    <Label htmlFor="discount">Descuento principal</Label>
                    <div className="grid grid-cols-3 gap-2">
                      <Input
                        id="discount"
                        type="number"
                        inputMode="decimal"
                        value={discount}
                        min={0}
                        step="0.01"
                        onChange={(e) => { setDiscount(Number(e.target.value)); setTouched((t) => ({ ...t, discount: true })); }}
                        aria-invalid={errors.length > 0}
                        aria-describedby={errors.length > 0 ? 'discount-errors' : undefined}
                        className="h-10 col-span-2"
                      />
                      <Select value={discountType} onValueChange={(val) => { setDiscountType(val as DiscountType); setTouched((t) => ({ ...t, type: true })); }}>
                        <SelectTrigger className="h-10">
                          <SelectValue placeholder="Tipo" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="PERCENTAGE">%</SelectItem>
                          <SelectItem value="FIXED_AMOUNT">$</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  <div className="space-y-1">
                    <Label>Opciones rápidas</Label>
                    <div className="flex flex-wrap gap-2">
                      <Button type="button" variant="outline" size="sm" onClick={() => setDiscount(5)}>5%</Button>
                      <Button type="button" variant="outline" size="sm" onClick={() => setDiscount(10)}>10%</Button>
                      <Button type="button" variant="outline" size="sm" onClick={() => setDiscount(15)}>15%</Button>
                      <Button type="button" variant="outline" size="sm" onClick={() => { setDiscountType('FIXED_AMOUNT'); setDiscount(10000); }}>10.000</Button>
                      <Button type="button" variant="outline" size="sm" onClick={() => { setDiscountType('FIXED_AMOUNT'); setDiscount(20000); }}>20.000</Button>
                    </div>
                  </div>

                  <div className="space-y-1">
                    <Label>Resumen</Label>
                    <div className="h-10 flex items-center justify-between rounded-md border bg-muted px-3">
                      <div className="text-xs text-muted-foreground">Antes</div>
                      <div className="text-sm font-medium">{fmtCurrency(baseTotals.total)}</div>
                    </div>
                  </div>
                </div>

                {/* Lista de descuentos adicionales */}
                <div className="space-y-2">
                  <Label className="text-sm font-medium">Descuentos adicionales</Label>
                  <div className="space-y-2">
                    {discountEntries.map((e, idx) => (
                      <div key={e.id} className="grid grid-cols-3 gap-2 items-end">
                        <Input
                          type="number"
                          inputMode="decimal"
                          value={e.value}
                          min={0}
                          step="0.01"
                          onChange={(ev) => {
                            const v = Number((ev.target as HTMLInputElement).value);
                            setDiscountEntries((list) => list.map((it) => it.id === e.id ? { ...it, value: v } : it));
                          }}
                          className="h-10 col-span-2"
                        />
                        <Select value={e.type} onValueChange={(val) => setDiscountEntries((list) => list.map((it) => it.id === e.id ? { ...it, type: val as DiscountType } : it))}>
                          <SelectTrigger className="h-10">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="PERCENTAGE">%</SelectItem>
                            <SelectItem value="FIXED_AMOUNT">$</SelectItem>
                          </SelectContent>
                        </Select>
                        <div className="col-span-3 flex justify-end">
                          <Button type="button" variant="ghost" size="sm" onClick={() => setDiscountEntries((list) => list.filter((it) => it.id !== e.id))}>Quitar</Button>
                        </div>
                      </div>
                    ))}
                    <Button type="button" variant="outline" size="sm" onClick={() => setDiscountEntries((list) => [...list, { id: Math.random().toString(36).slice(2), type: 'PERCENTAGE', value: 5 }])}>Añadir descuento</Button>
                  </div>
                </div>

                {/* Totales compuestos */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                  <div className="space-y-1">
                    <Label>Descuento total</Label>
                    <div className="h-10 flex items-center justify-between rounded-md border bg-muted px-3">
                      <div className="text-sm text-muted-foreground">Aplicado</div>
                      <div className="text-base font-bold">-{fmtCurrency(composedDiscountTotal)}</div>
                    </div>
                  </div>
                  <div className="space-y-1">
                    <Label>Total con descuento</Label>
                    <div className="h-10 flex items-center justify-between rounded-md border bg-muted px-3">
                      <div className="text-sm text-muted-foreground">A pagar</div>
                      <div className="text-base font-bold">{fmtCurrency(totals.total)}</div>
                    </div>
                  </div>
                  <div className="space-y-1">
                    <Label>Feedback</Label>
                    <div className="h-10 flex items-center justify-between rounded-md border bg-green-50 px-3">
                      <div className="text-xs text-green-700">Descuento actualizado</div>
                      <Badge variant="outline" className="text-xs">En tiempo real</Badge>
                    </div>
                  </div>
                </div>

                <div className="space-y-2">
                  <Label className="text-sm">Desglose</Label>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {breakdown.map((amt, idx) => (
                      <div key={idx} className="h-9 flex items-center justify-between rounded-md border bg-muted px-3 text-sm">
                        <div>{idx === 0 ? 'Principal' : `Desc.${idx} `}</div>
                        <div className="font-medium">-{fmtCurrency(amt)}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {errors.length > 0 && (
                  <div id="discount-errors" className="mt-1 p-3 rounded-md bg-destructive/10 text-destructive text-sm flex items-start gap-2">
                    <AlertTriangle className="h-4 w-4 mt-0.5" />
                    <ul className="space-y-1">
                      {errors.map((err, i) => (<li key={i}>{err}</li>))}
                    </ul>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          <Card className="animate-in fade-in-50">
            <Collapsible open={shippingOpen} onOpenChange={setShippingOpen}>
              <CardHeader className="flex flex-row items-center justify-between">
                <CardTitle className="text-lg flex items-center gap-2">
                  <Truck className="h-5 w-5" />
                  Costo de envío
                </CardTitle>
                <CollapsibleTrigger asChild>
                  <Button variant="ghost" size="sm" aria-expanded={shippingOpen} aria-controls="shipping-section">
                    {shippingOpen ? 'Ocultar' : 'Desplegar'}
                  </Button>
                </CollapsibleTrigger>
                <div className="flex items-center gap-2 ml-2">
                  <Label htmlFor="shipping-enable" className="text-sm">Habilitar envío</Label>
                  <Switch id="shipping-enable" checked={shippingEnabled} onCheckedChange={setShippingEnabled} />
                </div>
              </CardHeader>
              <CollapsibleContent id="shipping-section">
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div className="space-y-1">
                      <Label>Región</Label>
                      <Select value={shippingRegion} onValueChange={(v) => setShippingRegion(v)} disabled={!shippingEnabled}>
                        <SelectTrigger className="h-10">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="General">General</SelectItem>
                          {(config?.storeSettings?.freeShippingRegions || []).map((r) => (
                            <SelectItem key={r.name} value={r.name}>{r.name}</SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>
                    <div className="space-y-1">
                      <Label htmlFor="shipping-cost">Envío</Label>
                      <Input
                        id="shipping-cost"
                        type="number"
                        inputMode="decimal"
                        min={0}
                        step="0.01"
                        disabled={finalTotals.isFreeShipping || !shippingEnabled}
                        value={shippingInput}
                        onChange={(e) => {
                          const val = e.target.value;
                          setShippingInput(val);
                          const num = Number(val.replace(',', '.'));
                          setShippingCost(Number.isNaN(num) ? 0 : num);
                        }}
                        placeholder="0"
                        className="h-10"
                      />
                      <div className="text-xs text-muted-foreground">
                        {(() => {
                          const msg = config?.storeSettings?.freeShippingMessage || '';
                          const amt = fmtCurrency(finalTotals.threshold);
                          const base = msg ? msg.replace('{amount}', amt) : (finalTotals.threshold > 0 ? `Gratis desde ${amt} ` : 'Configura el costo de envío aquí');
                          return finalTotals.isFreeShipping ? base : base;
                        })()}
                      </div>
                    </div>
                    <div className="space-y-1">
                      <Label>Aplicado</Label>
                      <div className="h-10 flex items-center justify-between rounded-md border bg-muted px-3">
                        <div className="text-sm text-muted-foreground">Envío</div>
                        <div className="text-base font-bold">{finalTotals.isFreeShipping || !shippingEnabled ? 'Gratis' : fmtCurrency(finalTotals.appliedShipping)}</div>
                      </div>
                    </div>
                    <div className="space-y-1">
                      <Label>Total final</Label>
                      <div className="h-10 flex items-center justify-between rounded-md border bg-muted px-3">
                        <div className="text-sm text-muted-foreground">A pagar</div>
                        <div className="text-base font-bold">{fmtCurrency(finalTotals.grandTotal)}</div>
                      </div>
                    </div>
                  </div>
                  {shippingEnabled && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                      <div className="space-y-1">
                        <Label htmlFor="ship-street">Dirección</Label>
                        <Input id="ship-street" value={shippingAddress.street} onChange={(e) => setShippingAddress({ ...shippingAddress, street: e.target.value })} placeholder="Calle y número" />
                      </div>
                      <div className="space-y-1">
                        <Label htmlFor="ship-neighborhood">Barrio</Label>
                        <Input id="ship-neighborhood" value={shippingAddress.neighborhood} onChange={(e) => setShippingAddress({ ...shippingAddress, neighborhood: e.target.value })} placeholder="Barrio" />
                      </div>
                      <div className="space-y-1">
                        <Label htmlFor="ship-city">Ciudad</Label>
                        <Input id="ship-city" value={shippingAddress.city} onChange={(e) => setShippingAddress({ ...shippingAddress, city: e.target.value })} placeholder="Ciudad" />
                      </div>
                      <div className="space-y-1">
                        <Label htmlFor="ship-dept">Departamento</Label>
                        <Input id="ship-dept" value={shippingAddress.department} onChange={(e) => setShippingAddress({ ...shippingAddress, department: e.target.value })} placeholder="Departamento" />
                      </div>
                    </div>
                  )}
                </CardContent>
              </CollapsibleContent>
            </Collapsible>
          </Card>

          {/* Notas de la venta */}
          <Card className="animate-in fade-in-50">
            <CardHeader>
              <CardTitle className="text-lg">Observaciones</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-1">
                <Label htmlFor="sale-notes">Notas de la venta</Label>
                <Input id="sale-notes" value={localNotes} onChange={(e) => setLocalNotes(e.target.value)} placeholder="Opcional" aria-label="Notas de la venta" />
                <div className="text-xs text-muted-foreground">Se guardan temporalmente en esta sesión.</div>
              </div>
            </CardContent>
          </Card>

          {/* Actions */}
          <div className="sticky bottom-0 bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-t mt-2 pt-3">
            <div className="flex flex-col sm:flex-row gap-2 sm:justify-end">
              <Button variant="secondary" onClick={handleClear} className="w-full sm:w-auto">Limpiar</Button>
              <Button variant="outline" onClick={onClose} className="w-full sm:w-auto">Cancelar</Button>
              <Button onClick={handleConfirmClick} className="w-full sm:w-auto" disabled={isLoading || cart.length === 0 || insufficientStockItems.length > 0} aria-disabled={isLoading || cart.length === 0 || insufficientStockItems.length > 0} aria-label="Confirmar procesamiento de venta">
                {isLoading ? (
                  <div className="flex items-center gap-2">
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
                    Procesando...
                  </div>
                ) : (
                  <div className="flex items-center gap-2">
                    <CheckCircle className="h-4 w-4" />
                    Confirmar
                  </div>
                )}
              </Button>
            </div>
          </div>
        </div>

        {/* Inline confirmation dialog component */}
        <ConfirmationDialog />
      </DialogContent>
    </Dialog>
  );
}